day-store
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ __pycache__
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.cpython-313.pyc
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ models.cpython-313.pyc
‚îÇ   ‚îú‚îÄ‚îÄ core
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __pycache__
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.cpython-313.pyc
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db.cpython-313.pyc
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ security.cpython-313.pyc
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ security.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îî‚îÄ‚îÄ routers
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ __pycache__
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ __init__.cpython-313.pyc
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ categories.cpython-313.pyc
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ health.cpython-313.pyc
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ products.cpython-313.pyc
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ search.cpython-313.pyc
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ users.cpython-313.pyc
‚îÇ       ‚îú‚îÄ‚îÄ categories.py
‚îÇ       ‚îú‚îÄ‚îÄ health.py
‚îÇ       ‚îú‚îÄ‚îÄ products.py
‚îÇ       ‚îú‚îÄ‚îÄ search.py
‚îÇ       ‚îî‚îÄ‚îÄ users.py
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ project_structure.txt
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ static
‚îÇ   ‚îú‚îÄ‚îÄ app.js
‚îÇ   ‚îú‚îÄ‚îÄ cart.html
‚îÇ   ‚îú‚îÄ‚îÄ cart.js
‚îÇ   ‚îú‚îÄ‚îÄ catalog.js
‚îÇ   ‚îú‚îÄ‚îÄ common.js
‚îÇ   ‚îú‚îÄ‚îÄ header.js
‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ product.html
‚îÇ   ‚îú‚îÄ‚îÄ product.js
‚îÇ   ‚îú‚îÄ‚îÄ styles.css
‚îÇ   ‚îú‚îÄ‚îÄ user.html
‚îÇ   ‚îî‚îÄ‚îÄ user.js
‚îî‚îÄ‚îÄ x.py


# Files content (only from 'app' and 'static' folders)


--- app/models.py ---
from datetime import datetime
from enum import Enum
from typing import Optional, List

from pydantic import BaseModel, Field


class Category(str, Enum):
    LAPTOP = "LAPTOP"
    PC = "PC"
    HEADPHONE = "HEADPHONE"
    SMART_WATCH = "SMART_WATCH"
    CAMERA = "CAMERA"
    PHONE = "PHONE"


class ActionEnum(str, Enum):
    VIEW = "VIEW"
    LIKE = "LIKE"
    PURCHASE = "PURCHASE"


# ---------- Users ----------

class UserRegister(BaseModel):
    username: str
    password: str
    passwordConfirmation: str


class UserInDB(BaseModel):
    id: str
    username: str
    password: str


class UserPublic(BaseModel):
    id: str
    username: str


# ---------- Products ----------

class ProductIn(BaseModel):
    brand: Optional[str] = None
    model: Optional[str] = None
    price: Optional[int] = None
    category: Optional[Category] = None


class ProductOut(ProductIn):
    id: str


# ---------- Actions ----------

class UserActionOut(BaseModel):
    id: Optional[str] = None
    userId: str
    action: ActionEnum
    productId: Optional[str] = None
    category: Optional[Category] = None
    timestamp: datetime = Field(..., alias="timestamp")

--- app/main.py ---
from fastapi import FastAPI
import uvicorn

from fastapi.middleware.cors import CORSMiddleware
from starlette.staticfiles import StaticFiles

from app.core.config import settings
from app.core.security import ensure_service_user
from app.routers import health, users, products, categories, search


app = FastAPI(
    title="DayStore Backend (FastAPI)",
    version="1.0.0",
)


# CORS ‚Äî –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç –≤—ã–Ω–µ—Å–µ—à—å –æ—Ç–¥–µ–ª—å–Ω–æ
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)


@app.on_event("startup")
async def on_startup():
    # —Å–æ–∑–¥–∞—ë–º service_bot, –µ—Å–ª–∏ –µ–≥–æ –µ—â—ë –Ω–µ—Ç
    await ensure_service_user()


# API-—Ä–æ—É—Ç—ã
app.include_router(health.router)
app.include_router(users.router)
app.include_router(products.router)
app.include_router(categories.router)
app.include_router(search.router)

# –†–∞–∑–¥–∞—á–∞ —Ñ—Ä–æ–Ω—Ç–∞ –∏–∑ –ø–∞–ø–∫–∏ static
app.mount("/", StaticFiles(directory="static", html=True), name="static")


if __name__ == "__main__":
    uvicorn.run("app.main:app", host="0.0.0.0", port=settings.port, reload=True)

--- app/routers/users.py ---
from datetime import datetime
from typing import List, Optional, Dict

from fastapi import APIRouter, Depends, HTTPException, Query
from fastapi.responses import PlainTextResponse
from bson import ObjectId

from app.core.db import users_coll, actions_coll, products_coll
from app.core.security import hash_password, get_current_user
from app.models import (
    UserRegister,
    UserPublic,
    UserInDB,
    UserActionOut,
    ActionEnum,
    ProductOut,
    Category,
)

router = APIRouter(prefix="/api/v1/users", tags=["users"])


# ---------- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–æ—Ç–∫—Ä—ã—Ç—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç) ----------

@router.post("/registration")
async def register_user(body: UserRegister):
    if body.password != body.passwordConfirmation:
        raise HTTPException(status_code=400, detail="Passwords do not match")

    existing = await users_coll.find_one({"username": body.username})
    if existing:
        raise HTTPException(status_code=400, detail="Username already exists")

    doc = {
        "username": body.username,
        "password": hash_password(body.password),
    }
    res = await users_coll.insert_one(doc)
    return {"id": str(res.inserted_id), "username": body.username}


# ---------- –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ----------

@router.get("/me", response_model=UserPublic)
async def get_me(user: UserInDB = Depends(get_current_user)):
    return UserPublic(id=user.id, username=user.username)


@router.get("/me/username", response_class=PlainTextResponse)
async def get_me_username(user: UserInDB = Depends(get_current_user)):
    # —Ñ—Ä–æ–Ω—Ç –∂–¥—ë—Ç –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç, –ø–æ—ç—Ç–æ–º—É PlainTextResponse
    return user.username


@router.post("/me/update/username")
async def update_username(new_username: str, user: UserInDB = Depends(get_current_user)):
    if not new_username.strip():
        raise HTTPException(status_code=400, detail="Username cannot be empty")

    existing = await users_coll.find_one({"username": new_username})
    if existing and str(existing["_id"]) != user.id:
        raise HTTPException(status_code=400, detail="Username already exists")

    await users_coll.update_one(
        {"_id": ObjectId(user.id)},
        {"$set": {"username": new_username}},
    )
    return {"id": user.id, "username": new_username}


# ---------- –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π ----------

@router.get("/me/history", response_model=List[UserActionOut])
async def me_history(
    all: bool = Query(True),
    limit: Optional[int] = Query(None, ge=1, le=500),
    user: UserInDB = Depends(get_current_user),
):
    q: Dict = {"userId": user.id}
    if not all:
        q["action"] = {"$ne": ActionEnum.VIEW.value}

    cursor = actions_coll.find(q).sort("timestamp", -1)
    if limit:
        cursor = cursor.limit(limit)

    docs = await cursor.to_list(length=limit or 500)
    out: List[UserActionOut] = []
    for d in docs:
        out.append(
            UserActionOut(
                id=str(d.get("_id")),
                userId=d["userId"],
                action=d["action"],
                productId=d.get("productId"),
                category=d.get("category"),
                timestamp=d.get("timestamp", datetime.utcnow()),
            )
        )
    return out


# ---------- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ----------

def _weight(action: str) -> int:
    if action == ActionEnum.VIEW.value:
        return 1
    if action == ActionEnum.LIKE.value:
        return 3
    if action == ActionEnum.PURCHASE.value:
        return 5
    return 0


@router.get("/me/recommendation", response_model=List[ProductOut])
async def me_recommendation(
    limit: int = Query(10, ge=1, le=100),
    user: UserInDB = Depends(get_current_user),
):
    # 1) –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    acts = await actions_coll.find({"userId": user.id}).to_list(length=1000)
    if not acts:
        return []

    # 2) –°—á–∏—Ç–∞–µ–º score –ø–æ —Ç–æ–≤–∞—Ä–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    product_scores: Dict[str, float] = {}
    category_scores: Dict[str, float] = {}

    for a in acts:
        w = _weight(a["action"])
        pid = a.get("productId")
        cat = a.get("category")
        if pid:
            product_scores[pid] = product_scores.get(pid, 0.0) + w
        if cat:
            category_scores[cat] = category_scores.get(cat, 0.0) + w

    # 3) –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ —Å—á–∏—Ç–∞–µ–º –æ–±—â–∏–π score
    all_products = await products_coll.find({}).to_list(length=1000)
    scored: List[tuple] = []
    for p in all_products:
        pid = str(p["_id"])
        base = product_scores.get(pid, 0.0)
        cat = p.get("category")
        base += 0.5 * category_scores.get(cat, 0.0)
        if base <= 0:
            continue
        scored.append((base, p))

    scored.sort(key=lambda x: x[0], reverse=True)
    top = [p for _, p in scored[:limit]]

    res: List[ProductOut] = []
    for d in top:
        res.append(
            ProductOut(
                id=str(d["_id"]),
                brand=d.get("brand"),
                model=d.get("model"),
                price=d.get("price"),
                category=d.get("category"),
            )
        )
    return res

--- app/routers/health.py ---
from fastapi import APIRouter

router = APIRouter(prefix="/api/v1/health", tags=["health"])

@router.get("")
async def health():
    return {"status": "ok"}

--- app/routers/categories.py ---
from fastapi import APIRouter
from app.models import Category

router = APIRouter(prefix="/api/v1/categories", tags=["categories"])

@router.get("/")
async def list_categories():
    return [c.value for c in Category]

--- app/routers/__init__.py ---
from . import health, users, products

--- app/routers/products.py ---
from datetime import datetime
from typing import List, Optional

from fastapi import APIRouter, Depends, HTTPException, Query, Request
from bson import ObjectId
from pydantic import BaseModel

from app.core.db import products_coll, actions_coll
from app.core.security import get_current_user
from app.models import ProductOut, Category, ActionEnum, UserInDB

router = APIRouter(prefix="/api/v1/products", tags=["products"])


class ProductsResponse(BaseModel):
    count: int
    items: List[ProductOut]


async def _find_product_doc(product_id: str):
    # –ü—ã—Ç–∞–µ–º—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ id
    doc = await products_coll.find_one({"_id": product_id})
    if doc:
        return doc
    # –ü—ã—Ç–∞–µ–º—Å—è –∫–∞–∫ ObjectId
    if ObjectId.is_valid(product_id):
        doc = await products_coll.find_one({"_id": ObjectId(product_id)})
    return doc


def _product_out(doc) -> ProductOut:
    return ProductOut(
        id=str(doc["_id"]),
        brand=doc.get("brand"),
        model=doc.get("model"),
        price=doc.get("price"),
        category=doc.get("category"),
    )


@router.get("/", response_model=List[ProductOut])
async def list_products():
    docs = await products_coll.find({}).to_list(length=1000)
    if not docs:
        raise HTTPException(status_code=404, detail="No products found")
    return [_product_out(d) for d in docs]



# ---------- –ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ----------

@router.get("/by-category", response_model=ProductsResponse)
async def products_by_category(
    category: str = Query(..., description="CSV: LAPTOP,PHONE,..."),
):
    cats = [c.strip().upper() for c in category.split(",") if c.strip()]
    q = {"category": {"$in": cats}} if cats else {}
    docs = await products_coll.find(q).to_list(length=1000)
    items = [_product_out(d) for d in docs]
    return ProductsResponse(count=len(items), items=items)


# ---------- by-brand / by-model / by-price (–¥–æ–ø. —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã) ----------

@router.get("/by-brand", response_model=List[ProductOut])
async def products_by_brand(brand: str):
    docs = await products_coll.find({"brand": brand}).to_list(length=1000)
    return [_product_out(d) for d in docs]


@router.get("/by-model", response_model=List[ProductOut])
async def products_by_model(model: str):
    docs = await products_coll.find({"model": model}).to_list(length=1000)
    return [_product_out(d) for d in docs]


@router.get("/by-price", response_model=List[ProductOut])
async def products_by_price(
    min: Optional[int] = Query(None, ge=0),
    max: Optional[int] = Query(None, ge=0),
):
    q = {}
    if min is not None or max is not None:
        q["price"] = {}
        if min is not None:
            q["price"]["$gte"] = min
        if max is not None:
            q["price"]["$lte"] = max
    docs = await products_coll.find(q).to_list(length=1000)
    return [_product_out(d) for d in docs]


# ---------- –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç + VIEW ----------

@router.get("/{product_id}", response_model=ProductOut)
async def get_product(product_id: str, request: Request):
    doc = await _find_product_doc(product_id)
    if not doc:
        # —Å—Ç–∞—Ä—ã–π —Ñ—Ä–æ–Ω—Ç –æ–∂–∏–¥–∞–ª 500 ‚Üí –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∫–∞–∫ "Product not found"
        raise HTTPException(status_code=500, detail="Product not found")

    # –ï—Å–ª–∏ –µ—Å—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Äî –ø–∏—à–µ–º VIEW
    try:
        user: UserInDB = await get_current_user(request)
    except HTTPException:
        user = None

    if user:
        await actions_coll.insert_one(
            {
                "userId": user.id,
                "productId": str(doc["_id"]),
                "category": doc.get("category"),
                "action": ActionEnum.VIEW.value,
                "timestamp": datetime.utcnow(),
            }
        )

    return _product_out(doc)


# ---------- LIKE ----------

@router.post("/{product_id}/like")
async def like_product(product_id: str, user: UserInDB = Depends(get_current_user)):
    doc = await _find_product_doc(product_id)
    if not doc:
        raise HTTPException(status_code=500, detail="Product not found")

    # –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏ –ª–∞–π–∫–∞
    exists = await actions_coll.find_one(
        {"userId": user.id, "productId": str(doc["_id"]), "action": ActionEnum.LIKE.value}
    )
    if exists:
        raise HTTPException(status_code=400, detail="Like already exists")

    await actions_coll.insert_one(
        {
            "userId": user.id,
            "productId": str(doc["_id"]),
            "category": doc.get("category"),
            "action": ActionEnum.LIKE.value,
            "timestamp": datetime.utcnow(),
        }
    )
    return {"message": "liked"}


@router.delete("/{product_id}/like")
async def unlike_product(product_id: str, user: UserInDB = Depends(get_current_user)):
    doc = await _find_product_doc(product_id)
    if not doc:
        # –Ω–µ—Ç —Ç–∞–∫–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ ‚Äî –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞ –≤–µ—Ä–Ω—ë–º 204
        return {"status": 204}

    await actions_coll.delete_many(
        {
            "userId": user.id,
            "productId": str(doc["_id"]),
            "action": ActionEnum.LIKE.value,
        }
    )
    return {"status": 204}


# ---------- BUY ----------

@router.post("/{product_id}/buy")
async def buy_product(product_id: str, user: UserInDB = Depends(get_current_user)):
    doc = await _find_product_doc(product_id)
    if not doc:
        raise HTTPException(status_code=500, detail="Product not found")

    await actions_coll.insert_one(
        {
            "userId": user.id,
            "productId": str(doc["_id"]),
            "category": doc.get("category"),
            "action": ActionEnum.PURCHASE.value,
            "timestamp": datetime.utcnow(),
        }
    )
    return {"message": "purchased"}

--- app/routers/search.py ---
from typing import Optional, List

from fastapi import APIRouter, Query

from app.core.db import products_coll

router = APIRouter(prefix="/api/v1/search", tags=["search"])


def _match_tokens(s: str, tokens: List[str]) -> bool:
    s = (s or "").lower()
    return all(t in s for t in tokens)


@router.get("")
async def search(
    q: str = Query(""),
    category: Optional[str] = None,
    price_from: Optional[int] = None,
    price_to: Optional[int] = None,
    limit: int = Query(50, ge=1, le=200),
):
    docs = await products_coll.find({}).to_list(length=1000)
    tokens = [t.strip().lower() for t in q.split()] if q else []

    out = []
    for d in docs:
        if category and d.get("category") != category:
            continue
        price = d.get("price") or 0
        if price_from is not None and price < price_from:
            continue
        if price_to is not None and price > price_to:
            continue
        if tokens:
            hay = " ".join([str(d.get("brand") or ""), str(d.get("model") or "")])
            if not _match_tokens(hay, tokens):
                continue

        out.append(
            {
                "id": str(d["_id"]),
                "brand": d.get("brand"),
                "model": d.get("model"),
                "price": d.get("price"),
                "category": d.get("category"),
            }
        )
        if len(out) >= limit:
            break

    return {"count": len(out), "items": out}

--- app/core/db.py ---
from motor.motor_asyncio import AsyncIOMotorClient
from .config import settings

client = AsyncIOMotorClient(settings.mongo_uri)
db = client[settings.mongo_db]

users_coll = db["users"]
products_coll = db["products"]
actions_coll = db["user_actions"]

--- app/core/config.py ---
from pydantic import BaseModel
import os
from dotenv import load_dotenv

load_dotenv()


class Settings(BaseModel):
    # –ü–æ—Ä—Ç backend-—Å–µ—Ä–≤–∏—Å–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8080)
    port: int = int(os.getenv("PORT", "8080"))

    # Mongo
    mongo_uri: str = os.getenv("MONGO_URI", "mongodb://localhost:27017")
    mongo_db: str = os.getenv("MONGO_DB", "daystore")

    # –°–µ—Ä–≤–∏—Å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–¥–ª—è –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    svc_username: str = os.getenv("SVC_USERNAME", "service_bot")
    svc_password: str = os.getenv("SVC_PASSWORD", "service_bot_secret")


settings = Settings()

--- app/core/security.py ---
import base64
from typing import Optional

from fastapi import Depends, HTTPException, Request, status
from passlib.context import CryptContext
from bson import ObjectId

from .db import users_coll
from app.models import UserInDB
from .config import settings

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def hash_password(password: str) -> str:
    return pwd_context.hash(password)


def verify_password(plain: str, hashed: str) -> bool:
    # –µ—Å–ª–∏ –≤ –ë–î –≤–¥—Ä—É–≥ –ª–µ–∂–∏—Ç –Ω–µ bcrypt ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—Ä–∞–≤–Ω–∏ –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
    if hashed.startswith("$2a$") or hashed.startswith("$2b$") or hashed.startswith("$2y$"):
        return pwd_context.verify(plain, hashed)
    return plain == hashed


async def _find_user_by_username(username: str) -> Optional[UserInDB]:
    doc = await users_coll.find_one({"username": username})
    if not doc:
        return None
    return UserInDB(
        id=str(doc.get("_id")),
        username=doc["username"],
        password=doc["password"],
    )


async def get_current_user(request: Request) -> UserInDB:
    auth = request.headers.get("Authorization")
    if not auth or not auth.startswith("Basic "):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Not authenticated",
            headers={"WWW-Authenticate": "Basic"},
        )

    try:
        decoded = base64.b64decode(auth.split(" ", 1)[1]).decode("utf-8")
        username, password = decoded.split(":", 1)
    except Exception:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid Authorization header",
            headers={"WWW-Authenticate": "Basic"},
        )

    user = await _find_user_by_username(username)
    if not user or not verify_password(password, user.password):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid username or password",
            headers={"WWW-Authenticate": "Basic"},
        )

    return user


async def ensure_service_user():
    """
    –ß—Ç–æ–±—ã day-store –º–æ–≥ –∞–Ω–æ–Ω–∏–º–Ω–æ –ø–æ–ª—É—á–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ service_bot,
    —Å–æ–∑–¥–∞—ë–º (–µ—Å–ª–∏ –Ω–∞–¥–æ) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è service_bot –≤ Mongo.
    """
    existing = await users_coll.find_one({"username": settings.svc_username})
    if existing:
        return

    doc = {
        "username": settings.svc_username,
        "password": hash_password(settings.svc_password),
    }
    await users_coll.insert_one(doc)

--- static/index.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore ‚Äî –ö–∞—Ç–∞–ª–æ–≥</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container wide fade-in">

  <section class="hero">
    <div>
      <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –º–∞–≥–∞–∑–∏–Ω</h1>
      <p>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω —Ç–µ—Ö–Ω–∏–∫–∏ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏</p>
      <div class="searchbar">
        <input id="searchInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –±—Ä–µ–Ω–¥ –∏–ª–∏ –º–æ–¥–µ–ª—å‚Ä¶" />
        <button id="btnSearch" class="btn">–ü–æ–∏—Å–∫</button>
      </div>
    </div>
    <img src="https://cdn.jsdelivr.net/gh/encharm/Font-Awesome-SVG-PNG/white/png/256/laptop.png" alt="banner" style="justify-self:end;max-width:260px;">
  </section>

  <div class="layout" style="margin-top:32px;">
    <aside class="sidebar">
      <div class="section-title"><h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3></div>
      <div id="catFilters" class="chips">
        <label class="chip"><input type="checkbox" value="LAPTOP"> LAPTOP</label>
        <label class="chip"><input type="checkbox" value="PC"> PC</label>
        <label class="chip"><input type="checkbox" value="HEADPHONE"> HEADPHONE</label>
        <label class="chip"><input type="checkbox" value="SMART_WATCH"> SMART WATCH</label>
        <label class="chip"><input type="checkbox" value="CAMERA"> CAMERA</label>
        <label class="chip"><input type="checkbox" value="PHONE"> PHONE</label>
      </div>
      <div class="btn-row" style="margin-top:16px;">
        <button id="btnApplyCats" class="btn block outline">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button id="btnResetCats" class="btn block ghost">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </aside>

    <section class="panel">
      <div class="panel-title"><h2>–ö–∞—Ç–∞–ª–æ–≥</h2></div>
      <div id="products" class="grid auto-fit"></div>
    </section>
  </div>

  <section id="recoSection" class="panel" style="margin-top:40px;display:none;">
    <div class="panel-title">
      <h2>–í–∞—à–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
      <div id="recoHint" class="muted"></div>
    </div>
    <div id="recoList" class="grid auto-fit"></div>
  </section>

</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/catalog.js"></script>
</body>
</html>

--- static/product.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore ‚Äî Product</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container narrow">
  <section id="productBox" class="panel"></section>
</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/product.js"></script>
</body>
</html>

--- static/cart.js ---
import { cartList, cartRemove, cartClear, reflectAuthStatus, fetchJSON, getAuthToken, out } from "./common.js";

function render(){
  reflectAuthStatus();
  const items = cartList();
  const wrap = document.getElementById("cartList");
  if(!wrap) return;
  if(!items.length){ wrap.innerHTML = `<div class="muted">Your cart is empty</div>`; return; }
  wrap.innerHTML = `
    <table class="table">
      <thead><tr><th>Item</th><th>Price</th><th></th></tr></thead>
      <tbody>
        ${items.map(it=>`
          <tr>
            <td>${it.brand||"?"} ‚Äî ${it.model||"?"}<div class="mono">id: ${it.id}</div></td>
            <td>${it.price ?? "-"}</td>
            <td><button class="btn ghost rm" data-id="${it.id}">Remove</button></td>
          </tr>`).join("")}
      </tbody>
    </table>
  `;
}

async function checkout(){
  const items = cartList(); if(!items.length) return out("Cart is empty");
  if(!getAuthToken()) return out("Login required (Account page)");
  let ok=0, fail=0;
  for(const it of items){
    try{ await fetchJSON(`/api/v1/products/${it.id}/buy`, {method:"POST"}); ok++; }
    catch(e){ fail++; out(`Error ${it.id}: ${e.message}`); }
  }
  out(`Purchased: ${ok}, errors: ${fail}`);
  render();
}

document.addEventListener("click", e=>{
  const rm = e.target.closest("button.rm"); if(rm){ cartRemove(rm.dataset.id); render(); }
});
document.addEventListener("DOMContentLoaded", ()=>{
  render();
  document.getElementById("btnCheckout").addEventListener("click", checkout);
  document.getElementById("btnClear").addEventListener("click", ()=>{ cartClear(); render(); });
});

--- static/user.js ---
import { fetchJSON, makeBasic, setAuthToken, getAuthToken } from "./common.js";

function showHTML(html) {
  const box = document.getElementById("pretty");
  if (box) box.innerHTML = html;
}

/* ========== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–º–æ–∫) ========== */
async function onRegister() {
  const username = document.getElementById("regUser").value.trim();
  const password = document.getElementById("regPass").value;
  const confirm = document.getElementById("regPass2")?.value ?? password;

  if (!username || !password) {
    showHTML(`<div class="warn">‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å</div>`);
    return;
  }
  if (password !== confirm) {
    showHTML(`<div class="error">‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç</div>`);
    return;
  }

  showHTML(`
    <div class="card success fade-in">
      <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ</h3>
      <p>User '<b>${username || "dayana"}</b>' successfully registered</p>
    </div>
  `);
  console.log(`‚úÖ Mock registration ‚Üí user: ${username}, password: ${password}`);
}

/* ========== –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ========== */
async function onLogin() {
  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPass").value;
  if (!username || !password) {
    showHTML(`<div class="warn">‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å</div>`);
    return;
  }

  const token = makeBasic(username, password);
  try {
    const res = await fetch(`/api/v1/users/me/username`, {
      headers: { "Authorization": token }
    });
    const text = await res.text();

    if (!res.ok) throw new Error(text);

    setAuthToken(token);
    const cleanName = text.trim();

    showHTML(`
      <div class="card fade-in">
        <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
        <p>‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω –∫–∞–∫ <b>${cleanName}</b></p>
      </div>
    `);
  } catch (err) {
    setAuthToken("");
    showHTML(`<div class="error">‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${err.message}</div>`);
  }
}

/* ========== –í—ã—Ö–æ–¥ ========== */
function onLogout() {
  setAuthToken("");
  showHTML(`<div class="info">üö™ –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</div>`);
}

/* ========== –ö—Ç–æ —è ========== */
async function onWhoAmI() {
  if (!getAuthToken()) {
    showHTML(`<div class="warn">‚ùó –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ</div>`);
    return;
  }
  try {
    const data = await fetchJSON(`/api/v1/users/me/username`);
    const clean = (typeof data === "string")
      ? data.trim()
      : (data.user || data.username || "Unknown");

    showHTML(`
      <div class="card fade-in">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
        <p>üë§ <b>${clean}</b></p>
      </div>
    `);
  } catch (e) {
    showHTML(`<div class="error">–û—à–∏–±–∫–∞: ${e.message}</div>`);
  }
}

/* ========== –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π ========== */
async function onHistory() {
  if (!getAuthToken()) {
    showHTML(`<div class="warn">‚ùó –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>`);
    return;
  }
  try {
    const data = await fetchJSON(`/api/v1/users/me/history?all=true`);

    if (!Array.isArray(data) || !data.length) {
      showHTML(`<div class="muted">üì≠ –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>`);
      return;
    }

    const rows = data.map(a => `
      <tr>
        <td>${a.timestamp ?? "-"}</td>
        <td>${a.action ?? "-"}</td>
        <td>${a.productId ?? "-"}</td>
        <td>${a.category ?? "-"}</td>
      </tr>
    `).join("");

    showHTML(`
      <div class="card fade-in">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h3>
        <table class="table compact">
          <thead><tr><th>–í—Ä–µ–º—è</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th><th>ID —Ç–æ–≤–∞—Ä–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `);
  } catch (e) {
    showHTML(`<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${e.message}</div>`);
  }
}

/* ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ========== */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btnRegister").addEventListener("click", onRegister);
  document.getElementById("btnLogin").addEventListener("click", onLogin);
  document.getElementById("btnLogout").addEventListener("click", onLogout);
  document.getElementById("btnWhoAmI").addEventListener("click", onWhoAmI);
  document.getElementById("btnHistory").addEventListener("click", onHistory);
});

--- static/catalog.js ---
// catalog.js ‚Äî DayStore Front
import { fetchJSON, out, reflectAuthStatus, getAuthToken } from "./common.js";

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

// ===== PRODUCT CARD =====
function cardHtml(p) {
  return `
    <div class="card hover-raise">
      <div class="card-head">
        <h3 style="margin:0;font-size:18px">${escapeHtml(p.brand || "?")} ‚Äî ${escapeHtml(p.model || "?")}</h3>
        <a class="btn ghost" href="/product.html?id=${encodeURIComponent(p.id)}">Open</a>
      </div>
      <div class="mono">id: ${escapeHtml(p.id || "")}</div>
      <div>Category: <b>${escapeHtml(p.category || "-")}</b></div>
      <div>Price: <b class="price">${p.price ?? "-"}</b></div>
      <div class="actions">
        <button class="btn outline action" data-act="view" data-id="${p.id}">View</button>
        <button class="btn action" data-act="like" data-id="${p.id}">Like</button>
        <button class="btn ghost action" data-act="unlike" data-id="${p.id}">Unlike</button>
        <button class="btn success action" data-act="buy" data-id="${p.id}">Buy</button>
      </div>
    </div>
  `;
}

function renderProducts(items) {
  const wrap = document.getElementById("products");
  if (!wrap) return;
  wrap.innerHTML = items.map(cardHtml).join("");
}

// ===== LOAD PRODUCTS =====
async function loadProducts({ useCache = false } = {}) {
  try {
    const data = await fetchJSON(`/api/v1/products?use_cache=${useCache ? "true" : "false"}`);
    renderProducts(data.items || []);
    await maybeLoadRecommendations();
  } catch (e) {
    out(e.message);
  }
}

// ===== BUTTON ACTIONS =====
document.addEventListener("click", async (e) => {
  const btn = e.target.closest("button.action");
  if (!btn) return;
  const act = btn.dataset.act;
  const pid = btn.dataset.id;
  try {
    if (act === "view") {
      const data = await fetchJSON(`/api/v1/products/${pid}`);
      out(data);
    } else if (act === "like") {
      const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "POST" });
      out(data);
    } else if (act === "unlike") {
      const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "DELETE" });
      out(data);
    } else if (act === "buy") {
      const data = await fetchJSON(`/api/v1/products/${pid}/buy`, { method: "POST" });
      out(data);
    }
  } catch (err) {
    out(err.message);
  }
});

// ===== SEARCH =====
async function onSearch() {
  const q = document.getElementById("searchInput")?.value.trim() || "";
  try {
    const data = await fetchJSON(`/api/v1/search?q=${encodeURIComponent(q)}`);
    renderProducts(data.items || []);
    out({ search: q, count: data.count });
  } catch (e) {
    out(e.message);
  }
}

// ===== RECOMMENDATIONS =====
async function maybeLoadRecommendations() {
  const list = document.getElementById("recoList");
  const hint = document.getElementById("recoHint");
  const section = document.getElementById("recoSection");
  if (!list || !hint || !section) return;

  // –ø–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ü–∏—é —Å—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  section.style.display = "";
  hint.textContent = "üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...";
  list.innerHTML = `<div class="muted mono">Loading...</div>`;

  if (!getAuthToken()) {
    hint.textContent = "üîí –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏";
    list.innerHTML = `<div class="muted mono">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>`;
    return;
  }

  try {
    const data = await fetchJSON(`/api/v1/users/me/recommendation`);

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞: –∏—â–µ–º –º–∞—Å—Å–∏–≤ –≤ –ª—é–±—ã—Ö –ø–æ–ª—è—Ö
    let items = [];
    if (Array.isArray(data)) items = data;
    else if (Array.isArray(data.items)) items = data.items;
    else if (Array.isArray(data.data)) items = data.data;
    else if (Array.isArray(data.recommendations)) items = data.recommendations;

    if (!items.length) {
      list.innerHTML = `<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>`;
      hint.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
      section.style.display = "";
      return;
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    list.innerHTML = items
      .map(
        (p) => `
        <div class="card fade-in">
          <div class="card-head">
            <h4 style="margin:0">${escapeHtml(p.brand || "?")} ‚Äî ${escapeHtml(p.model || "?")}</h4>
            <a class="btn ghost" href="/product.html?id=${encodeURIComponent(p.id)}">Open</a>
          </div>
          <div class="mono">id: ${escapeHtml(p.id || "")}</div>
          <div>Category: <b>${escapeHtml(p.category || "-")}</b></div>
          <div>Price: <b>${p.price ?? "-"}</b></div>
        </div>`
      )
      .join("");

    hint.textContent = "üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏";
    section.style.display = ""; // –ø–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫
  } catch (e) {
    console.error("RECO ERROR:", e);
    hint.textContent = "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π";
    list.innerHTML = `<div class="muted">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>`;
    section.style.display = "";
  }
}

// ===== CATEGORY FILTERS =====
function selectedCategories() {
  const w = document.getElementById("catFilters");
  if (!w) return [];
  return [...w.querySelectorAll('input[type="checkbox"]')]
    .filter((i) => i.checked)
    .map((i) => i.value.trim().toUpperCase());
}

async function applyCategoryFilter() {
  const cats = selectedCategories();
  if (!cats.length) {
    await loadProducts({ useCache: false });
    return;
  }
  const csv = cats.join(",");
  try {
    const data = await fetchJSON(`/api/v1/products/by-category?category=${encodeURIComponent(csv)}`);
    renderProducts(data.items || []);
    out({ filter: cats, count: data.count });
  } catch (e) {
    out(e.message);
  }
}

function resetCategoryFilter() {
  const w = document.getElementById("catFilters");
  if (w) w.querySelectorAll('input[type="checkbox"]').forEach((i) => (i.checked = false));
  loadProducts({ useCache: false }).catch(console.error);
}

// ===== EVENT LIST–ï–ùERS =====
document.getElementById("btnSearch")?.addEventListener("click", onSearch);
document.getElementById("btnApplyCats")?.addEventListener("click", applyCategoryFilter);
document.getElementById("btnResetCats")?.addEventListener("click", resetCategoryFilter);

// ===== INIT =====
reflectAuthStatus();
loadProducts({ useCache: false }).catch(console.error);

--- static/user.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore ‚Äî –ê–∫–∫–∞—É–Ω—Ç</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container narrow fade-in">
  <section class="panel" style="margin-top:30px;">
    <div class="panel-title">
      <h2>–í—Ö–æ–¥ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
      <div class="muted">–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
    </div>

    <div class="grid cols-2" style="gap:24px;">
      <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
      <div class="card big fade-in">
        <h3 style="margin:0 0 12px">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
        <div class="u-col">
          <input id="regUser" class="input" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
          <input id="regPass" class="input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
          <input id="regPass2" class="input" type="password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
          <button id="btnRegister" class="btn block">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
      </div>

      <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
      <div class="card big fade-in">
        <h3 style="margin:0 0 12px">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
        <div class="u-col">
          <input id="loginUser" class="input" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
          <input id="loginPass" class="input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
        </div>
        <div class="btn-row" style="margin-top:10px;">
          <button id="btnLogin" class="btn">–í–æ–π—Ç–∏</button>
          <button id="btnLogout" class="btn ghost">–í—ã–π—Ç–∏</button>
        </div>
      </div>
    </div>
  </section>

  <section class="panel fade-in">
    <div class="panel-title"><h3>–î–µ–π—Å—Ç–≤–∏—è</h3></div>
    <div class="btn-row">
      <button id="btnWhoAmI" class="btn">–ö—Ç–æ —è</button>
      <button id="btnHistory" class="btn outline">–ò—Å—Ç–æ—Ä–∏—è</button>
    </div>
  </section>

  <section class="panel fade-in">
    <div class="panel-title"><h3>–†–µ–∑—É–ª—å—Ç–∞—Ç</h3></div>
    <div id="pretty" class="pretty"></div>
  </section>
</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/user.js"></script>
</body>
</html>

--- static/header.js ---
function renderHeader() {
  const host = document.getElementById("site-header");
  if (!host) return;

  host.innerHTML = `
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand"><span class="logo"></span><a href="/" class="brand-link">DayStore</a></div>

        <nav class="topnav">
          <a href="/" data-nav="catalog">Browse</a>
          <a href="/user.html" data-nav="user">Account</a>
          <a href="/cart.html" data-nav="cart">Cart <span data-cart-count class="mono" style="margin-left:6px;background:rgba(255,255,255,.06);padding:2px 8px;border-radius:999px">0</span></a>
        </nav>
        <div class="status"><span class="dot"></span><span data-auth-status>anonymous</span></div>
      </div>
    </div>
  `;

  const map = {
    "/": "catalog",
    "/index.html": "catalog",
    "/product.html": "catalog",
    "/user.html": "user",
    "/cart.html": "cart",
  };
  const active = map[(location.pathname||"/").toLowerCase()] || "catalog";
  host.querySelectorAll(".topnav a").forEach(a=>{
    a.classList.toggle("active", a.dataset.nav===active);
  });
}
document.addEventListener("DOMContentLoaded", renderHeader);

--- static/common.js ---
const LS_AUTH = "AUTH";
const LS_AUTH_TS = "AUTH_TS";
const SESSION_TTL_MS = 10 * 60 * 1000;

function nowMs(){ return Date.now(); }
function isExpired(ts){ return !ts || (nowMs()-ts)>SESSION_TTL_MS; }

export function getAuthToken(){
  const token = localStorage.getItem(LS_AUTH) || "";
  const ts = parseInt(localStorage.getItem(LS_AUTH_TS) || "0",10);
  if(!token) return "";
  if(isExpired(ts)){
    localStorage.removeItem(LS_AUTH); localStorage.removeItem(LS_AUTH_TS);
    reflectAuthStatus(); return "";
  }
  return token;
}
function touch(){ localStorage.setItem(LS_AUTH_TS, String(nowMs())); }

export function setAuthToken(token){
  if(token){ localStorage.setItem(LS_AUTH, token); touch(); }
  else { localStorage.removeItem(LS_AUTH); localStorage.removeItem(LS_AUTH_TS); }
  reflectAuthStatus();
}
export function makeBasic(u,p){ return "Basic " + btoa(`${u}:${p}`); }

export function reflectAuthStatus(){
  const s = document.querySelector("[data-auth-status]");
  if(s){
    const tok = getAuthToken();
    s.textContent = tok ? "authorized" : "anonymous";
    const dot = document.querySelector(".status .dot");
    if(dot) dot.style.background = tok ? "var(--success)" : "#ffd166";
  }
  document.querySelectorAll("[data-cart-count]").forEach(e=>e.textContent=String(cartCount()));
}

function attachAuth(opts={}){
  const headers = opts.headers || {};
  const tok = getAuthToken();
  if(tok && !headers["Authorization"]){ headers["Authorization"]=tok; touch(); }
  return {...opts, headers};
}

export async function fetchJSON(url, opts={}){
  const r = await fetch(url, attachAuth(opts));
  if(!r.ok){
    const txt = await r.text();
    if(r.status===401 || r.status===403){ setAuthToken(""); throw new Error("Unauthorized: go to Account and log in."); }
    throw new Error(`HTTP ${r.status}: ${txt}`);
  }
  const ct = r.headers.get("content-type")||"";
  return ct.includes("application/json") ? r.json() : r.text();
}

export function out(msg, id="output"){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = (typeof msg==="string") ? msg : JSON.stringify(msg,null,2);
}

/* --- Cart --- */
const LS_CART = "CART_V1";
function readCart(){ try{ return JSON.parse(localStorage.getItem(LS_CART)||"[]"); }catch{return []} }
function writeCart(items){ localStorage.setItem(LS_CART, JSON.stringify(items)); reflectAuthStatus(); }
export function cartList(){ return readCart(); }
export function cartCount(){ return readCart().length; }
export function cartAdd(item){ const xs = readCart(); if(!xs.find(x=>x.id===item.id)){ xs.push(item); writeCart(xs); } }
export function cartRemove(id){ writeCart(readCart().filter(x=>x.id!==id)); }
export function cartClear(){ writeCart([]); }

document.addEventListener("DOMContentLoaded", reflectAuthStatus);

--- static/cart.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore ‚Äî Cart</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container narrow">
  <section class="panel">
    <h2 style="margin:0 0 12px">Your Cart</h2>
    <div id="cartList"></div>
    <div class="actions" style="margin-top:12px">
      <button id="btnCheckout" class="btn success">Checkout</button>
      <button id="btnClear" class="btn ghost">Clear</button>
    </div>
  </section>
  <section>
    <h3>Console</h3>
    <pre id="output" class="log"></pre>
  </section>
</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/cart.js"></script>
</body>
</html>

--- static/product.js ---
import { fetchJSON, out, getAuthToken, cartAdd } from "./common.js";

function isLoggedIn(){ return !!getAuthToken(); }
function getId(){ return new URL(location.href).searchParams.get("id") || ""; }

function skeleton(id){
  const box = document.getElementById("productBox");
  box.innerHTML = `
    <div class="big card">
      <div class="card-head">
        <h2 id="pTitle" style="margin:0">Loading‚Ä¶</h2>
        <div class="mono">id: ${id}</div>
      </div>
      <div id="pInfo" class="kv" style="margin-top:10px">
        <div><span>Category</span><b>‚Äî</b></div>
        <div><span>Price</span><b>‚Äî</b></div>
        <div><span>Status</span><b id="pStatus" class="muted">Waiting server‚Ä¶</b></div>
      </div>
      <div class="actions" style="margin-top:14px">
        <button class="btn" data-act="view">View</button>
        <button class="btn ${isLoggedIn()?"":"ghost"} need-auth" data-act="like">Like</button>
        <button class="btn ghost need-auth" data-act="unlike">Unlike</button>
        <button class="btn outline" data-act="cart" data-brand="" data-model="" data-price="">Add to Cart</button>
        <button class="btn success need-auth" data-act="buy">Buy</button>
      </div>
    </div>
  `;
  reflectAuth();
}
function reflectAuth(){
  document.querySelectorAll(".need-auth").forEach(b=>{
    if(isLoggedIn()){ b.removeAttribute("disabled"); b.classList.remove("ghost"); }
    else { b.setAttribute("disabled","disabled"); b.classList.add("ghost"); }
  });
}

function hydrate(p){
  document.getElementById("pTitle").textContent = `${p.brand||"?"} ‚Äî ${p.model||"?"}`;
  document.getElementById("pInfo").innerHTML = `
    <div><span>Category</span><b>${p.category || "-"}</b></div>
    <div><span>Price</span><b>${p.price ?? "-"}</b></div>
    <div><span>Status</span><b class="muted">Ready</b></div>
  `;
  const btnCart = document.querySelector('button[data-act="cart"]');
  if(btnCart){ btnCart.dataset.brand = p.brand||""; btnCart.dataset.model = p.model||""; btnCart.dataset.price = p.price ?? ""; }
}
function notFound(){
  document.getElementById("pTitle").textContent = "Product not found";
  const s = document.getElementById("pStatus"); if(s) s.textContent="Check product id";
}

async function load(){
  const id = getId(); if(!id){ out("No product id specified"); return; }
  skeleton(id);
  try{ const data = await fetchJSON(`/api/v1/products/${encodeURIComponent(id)}`); hydrate(data); }
  catch(e){ notFound(); out(e.message); }
}

document.addEventListener("click", async (e)=>{
  const btn = e.target.closest("button.btn"); if(!btn) return;
  const act = btn.dataset.act; const id = getId();
  try{
    if(act==="view"){
      const data = await fetchJSON(`/api/v1/products/${id}`); out(data);
    }else if(act==="like"){
      if(!isLoggedIn()) return out("Login required");
      const data = await fetchJSON(`/api/v1/products/${id}/like`, {method:"POST"}); out(data);
    }else if(act==="unlike"){
      if(!isLoggedIn()) return out("Login required");
      const res = await fetchJSON(`/api/v1/products/${id}/like`, {method:"DELETE"});
      out(typeof res==="string"?res:"unliked (204)");
    }else if(act==="cart"){
      cartAdd({id, brand:btn.dataset.brand||"", model:btn.dataset.model||"", price: btn.dataset.price?Number(btn.dataset.price):null});
      out("Added to cart");
    }else if(act==="buy"){
      if(!isLoggedIn()) return out("Login required");
      const data = await fetchJSON(`/api/v1/products/${id}/buy`, {method:"POST"}); out(data);
    }
  }catch(err){ out(err.message); }
});

window.addEventListener("storage", ev=>{ if(ev.key==="AUTH"){ reflectAuth(); } });

document.addEventListener("DOMContentLoaded", load);

--- static/app.js ---
(function () {

  const out = (msg) => {
    const el = document.getElementById("output");
    el.textContent = (typeof msg === "string") ? msg : JSON.stringify(msg, null, 2);
  };


  function getAuthToken() { return localStorage.getItem("AUTH") || ""; }
  function setAuthToken(token) {
    if (token) localStorage.setItem("AUTH", token);
    else localStorage.removeItem("AUTH");
    reflectAuthStatus();
    updateControlsState();
  }
  function makeBasic(u, p) { return "Basic " + btoa(`${u}:${p}`); }

  function reflectAuthStatus() {
    const span = document.getElementById("authStatus");
    const tok = getAuthToken();
    if (!span) return;
    if (!tok) { span.textContent = "anonymous"; span.style.color = "#ffd166"; }
    else { span.textContent = "authorized"; span.style.color = "#06d6a0"; }
  }

  function updateControlsState() {
    const authed = !!getAuthToken();
    const btnWho = document.getElementById("btnWhoAmI");
    const btnHist = document.getElementById("btnHistory");
    const actions = document.querySelectorAll("button.action");

    if (btnWho) btnWho.disabled = !authed;
    if (btnHist) btnHist.disabled = !authed;

    actions.forEach(b => {
      const act = b.dataset.act;
      b.disabled = (act !== "view" && !authed);
    });
  }


  async function fetchJSON(url, opts = {}) {
    opts.headers = opts.headers || {};
    const auth = getAuthToken();
    if (auth && !opts.headers["Authorization"]) {
      opts.headers["Authorization"] = auth;
    }
    const r = await fetch(url, opts);
    if (!r.ok) {
      const txt = await r.text();
      if (r.status === 401 || r.status === 403) {
        throw new Error("Unauthorized: –≤–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å (Basic)");
      }
      throw new Error(`HTTP ${r.status}: ${txt}`);
    }
    const ct = r.headers.get("content-type") || "";
    return ct.includes("application/json") ? r.json() : r.text();
  }

  async function loadProducts() {
    try {
      const useCache = getAuthToken() ? "false" : "true";
      const data = await fetchJSON(`/api/v1/products?use_cache=${useCache}`);
      renderProducts(data.items || []);
      updateControlsState();
    } catch (e) {
      out(e.message);
    }
  }

  function renderProducts(items) {
    const wrap = document.getElementById("products");
    if (!wrap) return;
    wrap.innerHTML = "";
    items.forEach(p => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3>${p.brand || "?"} ‚Äî ${p.model || "?"}</h3>
        <div class="mono">id: ${p.id}</div>
        <div>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>${p.category || "-"}</b></div>
        <div>–¶–µ–Ω–∞: <b>${p.price ?? "-"}</b></div>
        <div class="actions">
          <button class="action" data-act="view" data-id="${p.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
          <button class="action" data-act="like" data-id="${p.id}">Like</button>
          <button class="action" data-act="unlike" data-id="${p.id}">Unlike</button>
          <button class="action" data-act="buy" data-id="${p.id}">Buy</button>
        </div>
      `;
      wrap.appendChild(card);
    });
  }

  async function onAction(e) {
    const btn = e.target.closest("button.action");
    if (!btn) return;
    const act = btn.dataset.act;
    const pid = btn.dataset.id;

    if ((act === "like" || act === "unlike" || act === "buy") && !getAuthToken()) {
      out("Unauthorized: —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ (Basic)");
      return;
    }

    try {
      if (act === "view") {
        const data = await fetchJSON(`/api/v1/products/${pid}`);
        out(data);
      } else if (act === "like") {
        const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "POST" });
        out(data);
      } else if (act === "unlike") {
        const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "DELETE" });
        out(data);
      } else if (act === "buy") {
        const data = await fetchJSON(`/api/v1/products/${pid}/buy`, { method: "POST" });
        out(data);
      }
    } catch (err) {
      out(err.message);
    }
  }

  async function onSearch() {
    const inp = document.getElementById("searchInput");
    const q = inp ? inp.value.trim() : "";
    try {
      const data = await fetchJSON(`/api/v1/search?q=${encodeURIComponent(q)}`);
      renderProducts(data.items || []);
      out({ search: q, count: data.count });
      updateControlsState();
    } catch (e) {
      out(e.message);
    }
  }


  async function onRegister() {
    const u = document.getElementById("authUser")?.value.trim();
    const p = document.getElementById("authPass")?.value;
    if (!u || !p) return out("–í–≤–µ–¥–∏—Ç–µ username –∏ password –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
    try {
      const res = await fetchJSON(`/api/v1/users/registration`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: u, password: p, passwordConfirmation: p })
      });
      out(res);
    } catch (e) {
      out(e.message);
    }
  }

  async function onLogin() {
    const u = document.getElementById("authUser")?.value.trim();
    const p = document.getElementById("authPass")?.value;
    if (!u || !p) return out("–í–≤–µ–¥–∏—Ç–µ username –∏ password –¥–ª—è –ª–æ–≥–∏–Ω–∞");
    const token = makeBasic(u, p);
    try {
      const r = await fetch(`/api/v1/users/me/username`, { headers: { "Authorization": token } });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`Login failed: HTTP ${r.status}: ${txt}`);
      }
      const txt = await r.text();
      setAuthToken(token);
      out({ login: "ok", whoami: txt.trim() });
      await loadProducts();
    } catch (e) {
      setAuthToken("");
      out(e.message);
    }
  }

  function onLogout() {
    setAuthToken("");
    out("logged out");
    updateControlsState();
  }

  async function whoAmI() {
    if (!getAuthToken()) { out("Unauthorized: –≤–æ–π–¥–∏—Ç–µ (Basic)"); return; }
    try {
      const data = await fetchJSON(`/api/v1/users/me/username`);
      out(data);
    } catch (e) {
      out(e.message);
    }
  }

  async function myHistory() {
    if (!getAuthToken()) { out("Unauthorized: –≤–æ–π–¥–∏—Ç–µ (Basic)"); return; }
    try {
      const data = await fetchJSON(`/api/v1/users/me/history?all=true`);
      out(data);
    } catch (e) {
      out(e.message);
    }
  }


  document.addEventListener("DOMContentLoaded", () => {

    document.addEventListener("click", onAction);

    document.getElementById("btnSearch")?.addEventListener("click", onSearch);
    document.getElementById("btnRegister")?.addEventListener("click", onRegister);
    document.getElementById("btnLogin")?.addEventListener("click", onLogin);
    document.getElementById("btnLogout")?.addEventListener("click", onLogout);
    document.getElementById("btnWhoAmI")?.addEventListener("click", whoAmI);
    document.getElementById("btnHistory")?.addEventListener("click", myHistory);

    reflectAuthStatus();
    loadProducts().finally(updateControlsState);
  });

})();
