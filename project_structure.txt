day-store
‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ __pycache__
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.cpython-313.pyc
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ models.cpython-313.pyc
‚îÇ   ‚îú‚îÄ‚îÄ core
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __pycache__
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.cpython-313.pyc
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db.cpython-313.pyc
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ security.cpython-313.pyc
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ security.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îî‚îÄ‚îÄ routers
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ __pycache__
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ __init__.cpython-313.pyc
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ categories.cpython-313.pyc
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ health.cpython-313.pyc
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ products.cpython-313.pyc
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ search.cpython-313.pyc
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ users.cpython-313.pyc
‚îÇ       ‚îú‚îÄ‚îÄ categories.py
‚îÇ       ‚îú‚îÄ‚îÄ health.py
‚îÇ       ‚îú‚îÄ‚îÄ products.py
‚îÇ       ‚îú‚îÄ‚îÄ search.py
‚îÇ       ‚îî‚îÄ‚îÄ users.py
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ project_structure.txt
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ static
‚îÇ   ‚îú‚îÄ‚îÄ app.js
‚îÇ   ‚îú‚îÄ‚îÄ cart.html
‚îÇ   ‚îú‚îÄ‚îÄ cart.js
‚îÇ   ‚îú‚îÄ‚îÄ catalog.js
‚îÇ   ‚îú‚îÄ‚îÄ common.js
‚îÇ   ‚îú‚îÄ‚îÄ header.js
‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ product.html
‚îÇ   ‚îú‚îÄ‚îÄ product.js
‚îÇ   ‚îú‚îÄ‚îÄ styles.css
‚îÇ   ‚îú‚îÄ‚îÄ user.html
‚îÇ   ‚îî‚îÄ‚îÄ user.js
‚îî‚îÄ‚îÄ x.py


# Files content (only from 'app' and 'static' folders)


--- app/models.py ---
from datetime import datetime
from enum import Enum
from typing import Optional, List

from pydantic import BaseModel, Field


class Category(str, Enum):
    LAPTOP = "LAPTOP"
    PC = "PC"
    HEADPHONE = "HEADPHONE"
    SMART_WATCH = "SMART_WATCH"
    CAMERA = "CAMERA"
    PHONE = "PHONE"


class ActionEnum(str, Enum):
    VIEW = "VIEW"
    LIKE = "LIKE"
    PURCHASE = "PURCHASE"

class UserRegister(BaseModel):
    username: str
    password: str
    passwordConfirmation: str


class UserInDB(BaseModel):
    id: str
    username: str
    password: str


class UserPublic(BaseModel):
    id: str
    username: str


class ProductIn(BaseModel):
    brand: Optional[str] = None
    model: Optional[str] = None
    price: Optional[int] = None
    category: Optional[Category] = None


class ProductOut(ProductIn):
    id: str


class UserActionOut(BaseModel):
    id: Optional[str] = None
    userId: str
    action: ActionEnum
    productId: Optional[str] = None
    category: Optional[Category] = None
    timestamp: datetime = Field(..., alias="timestamp")

class PurchaseOut(BaseModel):
    timestamp: datetime
    product: ProductOut

class UserPasswordUpdate(BaseModel):
    old_password: str
    new_password: str
    new_password_confirmation: str

class AdminPasswordUpdate(BaseModel):
    new_password: str
    new_password_confirmation: str

--- app/main.py ---
from fastapi import FastAPI
import uvicorn

from fastapi.middleware.cors import CORSMiddleware
from starlette.staticfiles import StaticFiles

from app.core.config import settings
from app.core.security import ensure_service_user
from app.routers import health, users, products, categories, search


app = FastAPI(
    title="DayStore Backend (FastAPI)",
    version="1.0.0",
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)


@app.on_event("startup")
async def on_startup():
    await ensure_service_user()

app.include_router(health.router)
app.include_router(users.router)
app.include_router(products.router)
app.include_router(categories.router)
app.include_router(search.router)

app.mount("/", StaticFiles(directory="static", html=True), name="static")


if __name__ == "__main__":
    uvicorn.run("app.main:app", host="0.0.0.0", port=settings.port, reload=True)

--- app/routers/users.py ---
from datetime import datetime
from typing import List, Optional, Dict

from fastapi import APIRouter, Depends, HTTPException, Query
from fastapi.responses import PlainTextResponse
from bson import ObjectId

from app.core.db import users_coll, actions_coll, products_coll
from app.core.security import hash_password, verify_password, get_current_user
from app.models import (
    UserRegister,
    UserPublic,
    UserInDB,
    UserActionOut,
    ActionEnum,
    ProductOut,
    Category,
    PurchaseOut,
    UserPasswordUpdate,
    AdminPasswordUpdate,
)


router = APIRouter(prefix="/api/v1/users", tags=["users"])

def _is_admin(user: UserInDB) -> bool:
    return user.username == "admin"


@router.post("/registration", response_model=UserPublic)
async def register_user(body: UserRegister):

    if body.password != body.passwordConfirmation:
        raise HTTPException(status_code=400, detail="Passwords do not match")

    if len(body.password) < 6:
        raise HTTPException(status_code=400, detail="Password must be at least 6 characters")

    if len(body.username.strip()) < 3:
        raise HTTPException(status_code=400, detail="Username must be at least 3 characters")

    existing = await users_coll.find_one({"username": body.username.strip()})
    if existing:
        raise HTTPException(status_code=400, detail="Username already exists")

    doc = {
        "username": body.username.strip(),
        "password": hash_password(body.password),
        "created_at": datetime.utcnow()
    }

    res = await users_coll.insert_one(doc)

    return UserPublic(id=str(res.inserted_id), username=body.username.strip())


@router.post("/login")
async def login_user(username: str, password: str):
    if not username or not password:
        raise HTTPException(status_code=400, detail="Username and password required")

    user_doc = await users_coll.find_one({"username": username.strip()})
    if not user_doc:
        raise HTTPException(status_code=401, detail="Invalid username or password")

    if not verify_password(password, user_doc["password"]):
        raise HTTPException(status_code=401, detail="Invalid username or password")

    return {
        "id": str(user_doc["_id"]),
        "username": user_doc["username"],
        "message": "Login successful"
    }


@router.get("/me", response_model=UserPublic)
async def get_me(user: UserInDB = Depends(get_current_user)):
    return UserPublic(id=user.id, username=user.username)


@router.get("/me/username", response_class=PlainTextResponse)
async def get_me_username(user: UserInDB = Depends(get_current_user)):

    return user.username


@router.post("/me/update/username", response_model=UserPublic)
async def update_username(new_username: str, user: UserInDB = Depends(get_current_user)):
    if not new_username.strip():
        raise HTTPException(status_code=400, detail="Username cannot be empty")

    if len(new_username.strip()) < 3:
        raise HTTPException(status_code=400, detail="Username must be at least 3 characters")

    existing = await users_coll.find_one({"username": new_username.strip()})
    if existing and str(existing["_id"]) != user.id:
        raise HTTPException(status_code=400, detail="Username already exists")

    await users_coll.update_one(
        {"_id": ObjectId(user.id)},
        {"$set": {"username": new_username.strip(), "updated_at": datetime.utcnow()}},
    )

    return UserPublic(id=user.id, username=new_username.strip())


@router.get("/me/history", response_model=List[UserActionOut])
async def me_history(
        all: bool = Query(True),
        limit: Optional[int] = Query(None, ge=1, le=500),
        user: UserInDB = Depends(get_current_user),
):
    q: Dict = {"userId": user.id}
    if not all:
        q["action"] = {"$ne": ActionEnum.VIEW.value}

    cursor = actions_coll.find(q).sort("timestamp", -1)
    if limit:
        cursor = cursor.limit(limit)

    docs = await cursor.to_list(length=limit or 500)
    out: List[UserActionOut] = []
    for d in docs:
        out.append(
            UserActionOut(
                id=str(d.get("_id")),
                userId=d["userId"],
                action=d["action"],
                productId=d.get("productId"),
                category=d.get("category"),
                timestamp=d.get("timestamp", datetime.utcnow()),
            )
        )
    return out


def _weight(action: str) -> int:
    if action == ActionEnum.VIEW.value:
        return 1
    if action == ActionEnum.LIKE.value:
        return 3
    if action == ActionEnum.PURCHASE.value:
        return 5
    return 0


@router.get("/me/recommendation", response_model=List[ProductOut])
async def me_recommendation(
        limit: int = Query(10, ge=1, le=100),
        user: UserInDB = Depends(get_current_user),
):

    acts = await actions_coll.find({"userId": user.id}).to_list(length=1000)
    if not acts:
        return []

    product_scores: Dict[str, float] = {}
    category_scores: Dict[str, float] = {}

    for a in acts:
        w = _weight(a["action"])
        pid = a.get("productId")
        cat = a.get("category")
        if pid:
            product_scores[pid] = product_scores.get(pid, 0.0) + w
        if cat:
            category_scores[cat] = category_scores.get(cat, 0.0) + w

    all_products = await products_coll.find({}).to_list(length=1000)
    scored: List[tuple] = []

    for p in all_products:
        pid = str(p["_id"])
        base = product_scores.get(pid, 0.0)
        cat = p.get("category")
        base += 0.5 * category_scores.get(cat, 0.0)
        if base <= 0:
            continue
        scored.append((base, p))

    scored.sort(key=lambda x: x[0], reverse=True)
    top = [p for _, p in scored[:limit]]

    res: List[ProductOut] = []
    for d in top:
        res.append(
            ProductOut(
                id=str(d["_id"]),
                brand=d.get("brand"),
                model=d.get("model"),
                price=d.get("price"),
                category=d.get("category"),
            )
        )
    return res

@router.get("/me/purchases", response_model=List[PurchaseOut])
async def me_purchases(
        limit: Optional[int] = Query(100, ge=1, le=500),
        user: UserInDB = Depends(get_current_user),
):
    q: Dict = {
        "userId": user.id,
        "action": ActionEnum.PURCHASE.value,
    }

    cursor = actions_coll.find(q).sort("timestamp", -1)
    if limit:
        cursor = cursor.limit(limit)

    acts = await cursor.to_list(length=limit or 500)
    result: List[PurchaseOut] = []

    for a in acts:
        pid = a.get("productId")
        if not pid:
            continue

        doc = await products_coll.find_one({"_id": ObjectId(pid)}) if ObjectId.is_valid(pid) \
            else await products_coll.find_one({"_id": pid})

        if not doc:
            continue

        product = ProductOut(
            id=str(doc["_id"]),
            brand=doc.get("brand"),
            model=doc.get("model"),
            price=doc.get("price"),
            category=doc.get("category"),
        )

        result.append(
            PurchaseOut(
                timestamp=a.get("timestamp", datetime.utcnow()),
                product=product,
            )
        )

    return result

@router.post("/me/update/password")
async def update_password(
    body: UserPasswordUpdate,
    user: UserInDB = Depends(get_current_user),
):
    if not verify_password(body.old_password, user.password):
        raise HTTPException(status_code=400, detail="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å —É–∫–∞–∑–∞–Ω –Ω–µ–≤–µ—Ä–Ω–æ")

    if len(body.new_password) < 6:
        raise HTTPException(status_code=400, detail="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤")

    if body.new_password != body.new_password_confirmation:
        raise HTTPException(status_code=400, detail="–ü–æ–≤—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç")

    if body.new_password == body.old_password:
        raise HTTPException(status_code=400, detail="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–∫—É—â–∏–º")

    await users_coll.update_one(
        {"_id": ObjectId(user.id)},
        {
            "$set": {
                "password": hash_password(body.new_password),
                "updated_at": datetime.utcnow(),
            }
        },
    )

    return {"message": "Password updated"}

@router.get("/admin/users", response_model=List[UserPublic])
async def admin_list_users(current: UserInDB = Depends(get_current_user)):
    if not _is_admin(current):
        raise HTTPException(status_code=403, detail="Admin only")

    cursor = users_coll.find({})
    docs = await cursor.to_list(length=1000)

    out: List[UserPublic] = []
    for d in docs:
        username = d.get("username", "")
        if username == "admin":
            continue
        out.append(UserPublic(id=str(d["_id"]), username=username))

    return out

@router.delete("/admin/users/{user_id}")
async def admin_delete_user(user_id: str, current: UserInDB = Depends(get_current_user)):
    if not _is_admin(current):
        raise HTTPException(status_code=403, detail="Admin only")

    doc = await users_coll.find_one({"_id": ObjectId(user_id)}) if ObjectId.is_valid(user_id) \
        else await users_coll.find_one({"_id": user_id})
    if not doc:
        raise HTTPException(status_code=404, detail="User not found")

    if doc.get("username") == "admin":
        raise HTTPException(status_code=400, detail="Cannot delete admin user")

    await users_coll.delete_one({"_id": doc["_id"]})
    await actions_coll.delete_many({"userId": str(doc["_id"])})

    return {"status": "deleted"}

@router.post("/admin/users/{user_id}/password")
async def admin_update_user_password(
    user_id: str,
    body: AdminPasswordUpdate,
    current: UserInDB = Depends(get_current_user),
):
    if not _is_admin(current):
        raise HTTPException(status_code=403, detail="Admin only")

    if len(body.new_password) < 6:
        raise HTTPException(status_code=400, detail="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤")

    if body.new_password != body.new_password_confirmation:
        raise HTTPException(status_code=400, detail="–ü–æ–≤—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç")

    doc = await users_coll.find_one({"_id": ObjectId(user_id)}) if ObjectId.is_valid(user_id) \
        else await users_coll.find_one({"_id": user_id})

    if not doc:
        raise HTTPException(status_code=404, detail="User not found")

    if doc.get("username") == "admin":
        raise HTTPException(status_code=400, detail="Cannot change admin password here")

    await users_coll.update_one(
        {"_id": doc["_id"]},
        {
            "$set": {
                "password": hash_password(body.new_password),
                "updated_at": datetime.utcnow(),
            }
        },
    )

    return {"message": "Password updated by admin"}


--- app/routers/health.py ---
from fastapi import APIRouter

router = APIRouter(prefix="/api/v1/health", tags=["health"])

@router.get("")
async def health():
    return {"status": "ok"}

--- app/routers/categories.py ---
from fastapi import APIRouter
from app.models import Category

router = APIRouter(prefix="/api/v1/categories", tags=["categories"])

@router.get("/")
async def list_categories():
    return [c.value for c in Category]

--- app/routers/__init__.py ---
from . import health, users, products

--- app/routers/products.py ---
from datetime import datetime
from typing import List, Optional

from fastapi import APIRouter, Depends, HTTPException, Query, Request
from bson import ObjectId
from pydantic import BaseModel

from app.core.db import products_coll, actions_coll
from app.core.security import get_current_user
from app.models import ProductOut, Category, ActionEnum, UserInDB

router = APIRouter(prefix="/api/v1/products", tags=["products"])

class ProductsResponse(BaseModel):
    count: int
    items: List[ProductOut]

async def _find_product_doc(product_id: str):
    doc = await products_coll.find_one({"_id": product_id})
    if doc:
        return doc
    if ObjectId.is_valid(product_id):
        doc = await products_coll.find_one({"_id": ObjectId(product_id)})
    return doc

def _product_out(doc) -> ProductOut:
    return ProductOut(
        id=str(doc["_id"]),
        brand=doc.get("brand"),
        model=doc.get("model"),
        price=doc.get("price"),
        category=doc.get("category"),
    )


@router.get("", response_model=ProductsResponse)  # <--- –í–ê–ñ–ù–û: –ø—É—Ç—å "" –≤–º–µ—Å—Ç–æ "/"
async def list_products():
    docs = await products_coll.find({}).to_list(length=1000)
    items = [_product_out(d) for d in docs]
    return ProductsResponse(count=len(items), items=items)


@router.get("/by-category", response_model=ProductsResponse)
async def products_by_category(
    category: str = Query(..., description="CSV: LAPTOP,PHONE,..."),
):
    cats = [c.strip().upper() for c in category.split(",") if c.strip()]
    q = {"category": {"$in": cats}} if cats else {}
    docs = await products_coll.find(q).to_list(length=1000)
    items = [_product_out(d) for d in docs]
    return ProductsResponse(count=len(items), items=items)


@router.get("/by-brand", response_model=List[ProductOut])
async def products_by_brand(brand: str):
    docs = await products_coll.find({"brand": brand}).to_list(length=1000)
    return [_product_out(d) for d in docs]


@router.get("/by-model", response_model=List[ProductOut])
async def products_by_model(model: str):
    docs = await products_coll.find({"model": model}).to_list(length=1000)
    return [_product_out(d) for d in docs]


@router.get("/by-price", response_model=List[ProductOut])
async def products_by_price(
    min: Optional[int] = Query(None, ge=0),
    max: Optional[int] = Query(None, ge=0),
):
    q = {}
    if min is not None or max is not None:
        q["price"] = {}
        if min is not None:
            q["price"]["$gte"] = min
        if max is not None:
            q["price"]["$lte"] = max
    docs = await products_coll.find(q).to_list(length=1000)
    return [_product_out(d) for d in docs]


@router.get("/{product_id}", response_model=ProductOut)
async def get_product(product_id: str, request: Request):
    doc = await _find_product_doc(product_id)
    if not doc:
        raise HTTPException(status_code=500, detail="Product not found")

    try:
        user: UserInDB = await get_current_user(request)
    except HTTPException:
        user = None

    if user:
        await actions_coll.insert_one(
            {
                "userId": user.id,
                "productId": str(doc["_id"]),
                "category": doc.get("category"),
                "action": ActionEnum.VIEW.value,
                "timestamp": datetime.utcnow(),
            }
        )

    return _product_out(doc)


@router.post("/{product_id}/like")
async def like_product(product_id: str, user: UserInDB = Depends(get_current_user)):
    doc = await _find_product_doc(product_id)
    if not doc:
        raise HTTPException(status_code=500, detail="Product not found")

    exists = await actions_coll.find_one(
        {"userId": user.id, "productId": str(doc["_id"]), "action": ActionEnum.LIKE.value}
    )
    if exists:
        raise HTTPException(status_code=400, detail="Like already exists")

    await actions_coll.insert_one(
        {
            "userId": user.id,
            "productId": str(doc["_id"]),
            "category": doc.get("category"),
            "action": ActionEnum.LIKE.value,
            "timestamp": datetime.utcnow(),
        }
    )
    return {"message": "liked"}


@router.delete("/{product_id}/like")
async def unlike_product(product_id: str, user: UserInDB = Depends(get_current_user)):
    doc = await _find_product_doc(product_id)
    if not doc:
        return {"status": 204}

    await actions_coll.delete_many(
        {
            "userId": user.id,
            "productId": str(doc["_id"]),
            "action": ActionEnum.LIKE.value,
        }
    )
    return {"status": 204}


@router.post("/{product_id}/buy")
async def buy_product(product_id: str, user: UserInDB = Depends(get_current_user)):
    doc = await _find_product_doc(product_id)
    if not doc:
        raise HTTPException(status_code=500, detail="Product not found")

    await actions_coll.insert_one(
        {
            "userId": user.id,
            "productId": str(doc["_id"]),
            "category": doc.get("category"),
            "action": ActionEnum.PURCHASE.value,
            "timestamp": datetime.utcnow(),
        }
    )
    return {"message": "purchased"}

--- app/routers/search.py ---
from typing import Optional, List
from fastapi import APIRouter, Query
from app.core.db import products_coll

router = APIRouter(prefix="/api/v1/search", tags=["search"])


def _match_tokens(s: str, tokens: List[str]) -> bool:
    s = (s or "").lower()
    return all(t in s for t in tokens)


@router.get("")
async def search(
    q: str = Query(""),
    category: Optional[str] = None,
    price_from: Optional[int] = None,
    price_to: Optional[int] = None,
    limit: int = Query(50, ge=1, le=200),
):
    docs = await products_coll.find({}).to_list(length=1000)
    tokens = [t.strip().lower() for t in q.split()] if q else []

    out = []
    for d in docs:
        if category and d.get("category") != category:
            continue
        price = d.get("price") or 0
        if price_from is not None and price < price_from:
            continue
        if price_to is not None and price > price_to:
            continue
        if tokens:
            hay = " ".join([str(d.get("brand") or ""), str(d.get("model") or "")])
            if not _match_tokens(hay, tokens):
                continue

        out.append(
            {
                "id": str(d["_id"]),
                "brand": d.get("brand"),
                "model": d.get("model"),
                "price": d.get("price"),
                "category": d.get("category"),
            }
        )
        if len(out) >= limit:
            break

    return {"count": len(out), "items": out}

--- app/core/db.py ---
from motor.motor_asyncio import AsyncIOMotorClient
from .config import settings

client = AsyncIOMotorClient(settings.mongo_uri)
db = client[settings.mongo_db]

users_coll = db["users"]
products_coll = db["products"]
actions_coll = db["user_actions"]

--- app/core/config.py ---
from pydantic import BaseModel
import os
from dotenv import load_dotenv

load_dotenv()


class Settings(BaseModel):
    port: int = int(os.getenv("PORT", "8080"))

    mongo_uri: str = os.getenv("MONGO_URI", "mongodb://localhost:27017")
    mongo_db: str = os.getenv("MONGO_DB", "daystore")

    svc_username: str = os.getenv("SVC_USERNAME", "service_bot")
    svc_password: str = os.getenv("SVC_PASSWORD", "service_bot_secret")


settings = Settings()

--- app/core/security.py ---
import base64
from typing import Optional
from fastapi import Depends, HTTPException, Request, status
from passlib.context import CryptContext
from .db import users_coll
from app.models import UserInDB
from .config import settings

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def hash_password(password: str) -> str:
    return pwd_context.hash(password)


def verify_password(plain: str, hashed: str) -> bool:
    if hashed.startswith("$2a$") or hashed.startswith("$2b$") or hashed.startswith("$2y$"):
        return pwd_context.verify(plain, hashed)
    return plain == hashed


async def _find_user_by_username(username: str) -> Optional[UserInDB]:
    doc = await users_coll.find_one({"username": username})
    if not doc:
        return None
    return UserInDB(
        id=str(doc.get("_id")),
        username=doc["username"],
        password=doc["password"],
    )


async def get_current_user(request: Request) -> UserInDB:
    auth = request.headers.get("Authorization")
    if not auth or not auth.startswith("Basic "):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Not authenticated"
        )

    try:
        decoded = base64.b64decode(auth.split(" ", 1)[1]).decode("utf-8")
        username, password = decoded.split(":", 1)
    except Exception:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid Authorization header"
        )

    user = await _find_user_by_username(username)
    if not user or not verify_password(password, user.password):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid username or password"
        )

    return user


async def ensure_service_user():
    existing = await users_coll.find_one({"username": settings.svc_username})
    if existing:
        return

    doc = {
        "username": settings.svc_username,
        "password": hash_password(settings.svc_password),
    }
    await users_coll.insert_one(doc)
--- static/index.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore ‚Äî –ö–∞—Ç–∞–ª–æ–≥</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container wide fade-in">

<section class="hero hero-compact">
  <div class="hero-main">
    <div>
      <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ DayStore</h1>
      <p class="hero-subtitle">
        –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω —Ç–µ—Ö–Ω–∏–∫–∏ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.
        –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª—å—à–µ —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤ –ø–æ –≤—ã–±–æ—Ä—É.
      </p>
      <p class="muted-2" style="font-size:13px;margin-top:6px;">
        –ù–∏–∂–µ –º—ã –ø–æ–∫–∞–∂–µ–º —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤–∞–º –ø–æ–¥–æ–π—Ç–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.
      </p>
    </div>

    <img
      src="https://cdn.jsdelivr.net/gh/encharm/Font-Awesome-SVG-PNG/white/png/256/laptop.png"
      alt="banner"
      class="hero-image"
      style="justify-self:end;max-width:220px;opacity:.95;"
    >
  </div>

  <div class="hero-reco">
    <div class="hero-reco-header">
      <span class="muted">üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—Å</span>
      <span id="recoHint" class="muted-2" style="font-size:13px;"></span>
    </div>
    <div id="recoList" class="hero-reco-list">
    </div>
  </div>
</section>


  <section class="panel filters-panel" style="margin-top:20px;">
    <div class="filters-row">
      <div class="filters-search">
        <label class="muted" for="searchInput" style="display:block;margin-bottom:6px;">–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É</label>
        <div class="searchbar" style="margin-top:0;">
          <input id="searchInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –±—Ä–µ–Ω–¥ –∏–ª–∏ –º–æ–¥–µ–ª—å‚Ä¶" />
          <button id="btnSearch" class="btn">–ü–æ–∏—Å–∫</button>
        </div>
      </div>

      <div class="filters-cats">
        <div class="row between wrap" style="margin-bottom:6px;">
          <span class="muted">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
          <div class="btn-row" style="gap:8px;">
            <button id="btnApplyCats" class="btn outline">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button id="btnResetCats" class="btn ghost">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>
        <div id="catFilters" class="chips">
          <label class="chip"><input type="checkbox" value="LAPTOP"> LAPTOP</label>
          <label class="chip"><input type="checkbox" value="PC"> PC</label>
          <label class="chip"><input type="checkbox" value="HEADPHONE"> HEADPHONE</label>
          <label class="chip"><input type="checkbox" value="SMART_WATCH"> SMART WATCH</label>
          <label class="chip"><input type="checkbox" value="CAMERA"> CAMERA</label>
          <label class="chip"><input type="checkbox" value="PHONE"> PHONE</label>
        </div>
      </div>
    </div>
  </section>

  <section class="panel" style="margin-top:20px;">
    <div class="panel-title">
      <h2>–ö–∞—Ç–∞–ª–æ–≥</h2>
    </div>
    <div id="products" class="grid auto-fit"></div>
  </section>

</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/catalog.js"></script>
</body>
</html>

--- static/product.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore ‚Äî Product</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container narrow">
  <section id="productBox" class="panel"></section>
</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/product.js"></script>
</body>
</html>

--- static/cart.js ---
import { cartList, cartRemove, cartClear, reflectAuthStatus, fetchJSON, getAuthToken, out } from "./common.js";

function render(){
  reflectAuthStatus();
  const items = cartList();
  const wrap = document.getElementById("cartList");
  if(!wrap) return;
  if(!items.length){ wrap.innerHTML = `<div class="muted">Your cart is empty</div>`; return; }
  wrap.innerHTML = `
    <table class="table">
      <thead><tr><th>Item</th><th>Price</th><th></th></tr></thead>
      <tbody>
        ${items.map(it=>`
          <tr>
            <td>${it.brand||"?"} ‚Äî ${it.model||"?"}<div class="mono">id: ${it.id}</div></td>
            <td>${it.price ?? "-"}</td>
            <td><button class="btn ghost rm" data-id="${it.id}">Remove</button></td>
          </tr>`).join("")}
      </tbody>
    </table>
  `;
}

async function checkout(){
  const items = cartList(); if(!items.length) return out("Cart is empty");
  if(!getAuthToken()) return out("Login required (Account page)");
  let ok=0, fail=0;
  for(const it of items){
    try{ await fetchJSON(`/api/v1/products/${it.id}/buy`, {method:"POST"}); ok++; }
    catch(e){ fail++; out(`Error ${it.id}: ${e.message}`); }
  }
  out(`Purchased: ${ok}, errors: ${fail}`);
  render();
}

document.addEventListener("click", e=>{
  const rm = e.target.closest("button.rm"); if(rm){ cartRemove(rm.dataset.id); render(); }
});
document.addEventListener("DOMContentLoaded", ()=>{
  render();
  document.getElementById("btnCheckout").addEventListener("click", checkout);
  document.getElementById("btnClear").addEventListener("click", ()=>{ cartClear(); render(); });
});

--- static/user.js ---
import { fetchJSON, makeBasic, setAuthToken, getAuthToken } from "./common.js";

const LS_AUTH_USER = "AUTH_USER";

function showHTML(html) {
  const box = document.getElementById("pretty");
  const panel = document.getElementById("messagesPanel");

  if (box) {
    box.innerHTML = html;
  }

  if (panel) {
    const hasContent = html && String(html).trim().length > 0;
    panel.style.display = hasContent ? "block" : "none";
  }
}

let IS_ADMIN = false;

function formatAction(action) {
  switch (action) {
    case "VIEW":
      return "–ü—Ä–æ—Å–º–æ—Ç—Ä";
    case "LIKE":
      return "–õ–∞–π–∫";
    case "PURCHASE":
      return "–ü–æ–∫—É–ø–∫–∞";
    default:
      return action || "-";
  }
}

async function onRegister() {
  const username = document.getElementById("regUser").value.trim();
  const password = document.getElementById("regPass").value;
  const confirm = document.getElementById("regPass2")?.value ?? password;

  if (!username || !password) {
    showHTML(`<div class="warn">‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ –ø–∞—Ä–æ–ª—å</div>`);
    return;
  }

  if (username.length < 3) {
    showHTML(`<div class="warn">‚ö†Ô∏è –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤</div>`);
    return;
  }

  if (password.length < 6) {
    showHTML(`<div class="warn">‚ö†Ô∏è –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤</div>`);
    return;
  }

  if (password !== confirm) {
    showHTML(`<div class="error">‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç</div>`);
    return;
  }

  try {
    const response = await fetch(`/api/v1/users/registration`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        username: username,
        password: password,
        passwordConfirmation: confirm
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      let errorMsg = errorText;
      try {
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.detail || errorText;
      } catch (e) {}
      throw new Error(errorMsg);
    }

    const data = await response.json();

    showHTML(`
      <div class="card success fade-in">
        <h3>‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ</h3>
        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '<b>${data.username}</b>' —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</p>
        <p class="muted">–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</p>
      </div>
    `);

    document.getElementById("regUser").value = "";
    document.getElementById("regPass").value = "";
    document.getElementById("regPass2").value = "";

  } catch (err) {
    showHTML(`<div class="error">‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${err.message}</div>`);
    console.error("Registration error:", err);
  }
}

async function loadAdminUsers() {
  const box = document.getElementById("adminUsersContent");
  const wrapper = document.getElementById("adminUsersBox");

  if (!box || !wrapper) return;

  if (!getAuthToken() || !IS_ADMIN) {
    wrapper.style.display = "none";
    return;
  }

  wrapper.style.display = "block";
  box.innerHTML = `<div class="muted mono">–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π‚Ä¶</div>`;

  try {
    const users = await fetchJSON(`/api/v1/users/admin/users`);

    if (!Array.isArray(users) || !users.length) {
      box.innerHTML = `<div class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
      return;
    }

    const rows = users
      .map(
        (u) => `
      <tr>
        <td>${u.username}</td>
        <td class="mono">${u.id ? u.id.substring(0, 8) + "..." : "-"}</td>
        <td>
          <button class="btn outline small btn-admin-pass" data-id="${u.id}" data-username="${u.username}">
            Update password
          </button>
          <button class="btn danger small btn-admin-del" data-id="${u.id}" data-username="${u.username}" style="margin-left:6px;">
            Delete
          </button>
        </td>
      </tr>
    `
      )
      .join("");

    box.innerHTML = `
      <table class="table compact">
        <thead>
          <tr>
            <th>Username</th>
            <th>ID</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  } catch (e) {
    box.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${e.message}</div>`;
    console.error("Admin users load error:", e);
  }
}

async function onLogin() {
  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPass").value;

  if (!username || !password) {
    showHTML(`<div class="warn">‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å</div>`);
    return;
  }

  const token = makeBasic(username, password);

  try {
    const response = await fetch(`/api/v1/users/me/username`, {
      headers: {
        Authorization: token
      }
    });

    if (!response.ok) {
      let errorMsg = "–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å";
      try {
        const errorText = await response.text();
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.detail || errorMsg;
      } catch (e) {}
      throw new Error(errorMsg);
    }

    const usernameFromServer = await response.text();
    const cleanName = usernameFromServer.trim();

    setAuthToken(token);
    localStorage.setItem(LS_AUTH_USER, cleanName);

    showHTML(`
      <div class="card success fade-in">
        <h3>üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
        <p>‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω –∫–∞–∫ <b>${cleanName}</b></p>
        <p class="muted">–¢–µ–ø–µ—Ä—å –≤–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</p>
      </div>
    `);

    document.getElementById("loginPass").value = "";

    if (window.reflectAuthStatus) {
      window.reflectAuthStatus();
    }

    await onWhoAmI();
    await onHistory();
    await onPurchases();

  } catch (err) {
    setAuthToken("");
    localStorage.removeItem(LS_AUTH_USER);
    showHTML(`<div class="error">‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${err.message}</div>`);
    console.error("Login error:", err);
  }
}

function onLogout() {
  setAuthToken("");
  localStorage.removeItem(LS_AUTH_USER);

  showHTML(`
    <div class="info fade-in">
      <h3>üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!</h3>
      <p>üö™ –í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</p>
    </div>
  `);

  document.getElementById("loginUser").value = "";
  document.getElementById("loginPass").value = "";

  document.getElementById("userInfo").innerHTML =
    `<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</div>`;
  document.getElementById("historyContent").innerHTML =
    `<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>`;
  document.getElementById("purchasesContent").innerHTML =
    `<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫</div>`;

  IS_ADMIN = false;
  const adminBox = document.getElementById("adminUsersBox");
  if (adminBox) adminBox.style.display = "none";

  if (window.reflectAuthStatus) {
    window.reflectAuthStatus();
  }
}

async function onWhoAmI() {
  const userInfoDiv = document.getElementById("userInfo");

  if (!getAuthToken()) {
    userInfoDiv.innerHTML =
      `<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</div>`;
    IS_ADMIN = false;
    const adminBox = document.getElementById("adminUsersBox");
    if (adminBox) adminBox.style.display = "none";
    return;
  }

  const cachedName = localStorage.getItem(LS_AUTH_USER);
  if (cachedName) {
    userInfoDiv.innerHTML = `
      <div class="kv">
        <div><span>Username</span><b>${cachedName}</b></div>
      </div>
    `;
  } else {
    userInfoDiv.innerHTML = `<div class="muted">–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é‚Ä¶</div>`;
  }

  try {
    const response = await fetch(`/api/v1/users/me`, {
      headers: {
        Authorization: getAuthToken()
      }
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();

    userInfoDiv.innerHTML = `
      <div class="kv">
        <div><span>Username</span><b>${data.username}</b></div>
      </div>
    `;

    localStorage.setItem(LS_AUTH_USER, data.username || "");

    IS_ADMIN = data.username === "admin";

    const adminBox = document.getElementById("adminUsersBox");
    if (adminBox) {
      adminBox.style.display = IS_ADMIN ? "block" : "none";
    }
    if (IS_ADMIN) {
      await loadAdminUsers();
    }
  } catch (e) {
    userInfoDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${e.message}</div>`;
    IS_ADMIN = false;
    const adminBox = document.getElementById("adminUsersBox");
    if (adminBox) adminBox.style.display = "none";
    console.error("WhoAmI error:", e);
  }
}

async function onHistory() {
  const historyDiv = document.getElementById("historyContent");

  if (!getAuthToken()) {
    historyDiv.innerHTML =
      `<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>`;
    return;
  }

  try {
    const data = await fetchJSON(`/api/v1/users/me/history?all=true`);

    if (!Array.isArray(data) || !data.length) {
      historyDiv.innerHTML = `<div class="muted">üì≠ –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø—É—Å—Ç–∞</div>`;
      return;
    }

    const rows = data
      .map((a) => {
        const date = new Date(a.timestamp);
        const formattedDate = date.toLocaleString("ru-RU");

        return `
        <tr>
          <td>${formattedDate}</td>
          <td><span class="badge-inline">${formatAction(a.action)}</span></td>
          <td class="mono">${a.productId ? a.productId.substring(0, 8) + "..." : "-"}</td>
          <td>${a.category ?? "-"}</td>
        </tr>
      `;
      })
      .join("");

    historyDiv.innerHTML = `
      <p class="muted" style="margin-bottom:12px;">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${data.length}</p>
      <table class="table compact">
        <thead>
          <tr>
            <th>–í—Ä–µ–º—è</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            <th>ID —Ç–æ–≤–∞—Ä–∞</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  } catch (e) {
    historyDiv.innerHTML =
      `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${e.message}</div>`;
    console.error("History error:", e);
  }
}

async function onPurchases() {
  const box = document.getElementById("purchasesContent");

  if (!getAuthToken()) {
    box.innerHTML =
      `<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫</div>`;
    return;
  }

  try {
    const data = await fetchJSON(`/api/v1/users/me/purchases`);

    if (!Array.isArray(data) || !data.length) {
      box.innerHTML = `<div class="muted">üõí –ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–∫—É–ø–æ–∫</div>`;
      return;
    }

    const rows = data
      .map((p) => {
        const date = new Date(p.timestamp);
        const formattedDate = date.toLocaleString("ru-RU");
        const prod = p.product || {};

        return `
        <tr>
          <td>${formattedDate}</td>
          <td>${prod.brand || "?"}</td>
          <td>${prod.model || "?"}</td>
          <td>${prod.category ?? "-"}</td>
          <td>${prod.price ?? "-"}</td>
          <td class="mono">${prod.id ? prod.id.substring(0, 8) + "..." : "-"}</td>
        </tr>
      `;
      })
      .join("");

    box.innerHTML = `
      <p class="muted" style="margin-bottom:12px;">–í—Å–µ–≥–æ –ø–æ–∫—É–ø–æ–∫: ${data.length}</p>
      <table class="table compact">
        <thead>
          <tr>
            <th>–í—Ä–µ–º—è</th>
            <th>–ë—Ä–µ–Ω–¥</th>
            <th>–ú–æ–¥–µ–ª—å</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>–¶–µ–Ω–∞</th>
            <th>ID —Ç–æ–≤–∞—Ä–∞</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  } catch (e) {
    box.innerHTML =
      `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫: ${e.message}</div>`;
    console.error("Purchases error:", e);
  }
}

async function onUpdatePassword() {
  const oldPass = document.getElementById("updOldPass").value;
  const newPass = document.getElementById("updNewPass").value;
  const newPass2 = document.getElementById("updNewPass2").value;

  if (!getAuthToken()) {
    showHTML(
      `<div class="warn">‚ö†Ô∏è –î–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</div>`
    );
    return;
  }

  if (!oldPass || !newPass || !newPass2) {
    showHTML(`<div class="warn">‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è</div>`);
    return;
  }

  if (newPass.length < 6) {
    showHTML(
      `<div class="warn">‚ö†Ô∏è –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤</div>`
    );
    return;
  }

  if (newPass !== newPass2) {
    showHTML(`<div class="error">‚ùå –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç</div>`);
    return;
  }

  if (newPass === oldPass) {
    showHTML(
      `<div class="warn">‚ö†Ô∏è –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º</div>`
    );
    return;
  }

  try {
    const resp = await fetch(`/api/v1/users/me/update/password`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: getAuthToken()
      },
      body: JSON.stringify({
        old_password: oldPass,
        new_password: newPass,
        new_password_confirmation: newPass2
      })
    });

    if (!resp.ok) {
      const txt = await resp.text();
      let msg = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å";
      try {
        const j = JSON.parse(txt);
        if (j.detail) msg = j.detail;
      } catch (e) {
        if (txt) msg = txt;
      }
      throw new Error(msg);
    }

    showHTML(`
      <div class="card success fade-in">
        <h3>‚úÖ –ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω</h3>
        <p>–í–∞—à –ø–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.</p>
      </div>
    `);

    document.getElementById("updOldPass").value = "";
    document.getElementById("updNewPass").value = "";
    document.getElementById("updNewPass2").value = "";

    setAuthToken("");
    localStorage.removeItem(LS_AUTH_USER);

    if (window.reflectAuthStatus) {
      window.reflectAuthStatus();
    }

    document.getElementById("userInfo").innerHTML =
      `<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</div>`;
    document.getElementById("historyContent").innerHTML =
      `<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>`;
    document.getElementById("purchasesContent").innerHTML =
      `<div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫</div>`;
  } catch (err) {
    showHTML(`<div class="error">‚ùå –û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è: ${err.message}</div>`);
    console.error("Update password error:", err);
  }
}

function initUserPage() {
  document.getElementById("btnRegister")?.addEventListener("click", onRegister);
  document.getElementById("btnLogin")?.addEventListener("click", onLogin);
  document.getElementById("btnLogout")?.addEventListener("click", onLogout);
  document.getElementById("btnHistory")?.addEventListener("click", onHistory);
  document.getElementById("btnPurchases")?.addEventListener("click", onPurchases);
  document
    .getElementById("btnUpdatePassword")
    ?.addEventListener("click", onUpdatePassword);
  document
    .getElementById("btnReloadUsers")
    ?.addEventListener("click", loadAdminUsers);

  document.getElementById("regPass2")?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") onRegister();
  });

  document.getElementById("loginPass")?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") onLogin();
  });

  document.getElementById("updNewPass2")?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") onUpdatePassword();
  });

  if (getAuthToken()) {
    onWhoAmI();
    onHistory();
    onPurchases();
  } else {
    localStorage.removeItem(LS_AUTH_USER);
  }
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initUserPage);
} else {
  initUserPage();
}

document.addEventListener("click", async (e) => {
  const passBtn = e.target.closest(".btn-admin-pass");
  const delBtn = e.target.closest(".btn-admin-del");

  if (passBtn) {
    if (!IS_ADMIN || !getAuthToken()) {
      showHTML(`<div class="warn">‚ö†Ô∏è –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è admin</div>`);
      return;
    }

    const userId = passBtn.dataset.id;
    const username = passBtn.dataset.username || "?";

    const newPass = prompt(
      `–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}":`
    );
    if (!newPass) return;
    const newPass2 = prompt(
      `–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è "${username}":`
    );
    if (!newPass2) return;

    if (newPass !== newPass2) {
      showHTML(`<div class="error">‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç</div>`);
      return;
    }

    if (newPass.length < 6) {
      showHTML(
        `<div class="warn">‚ö†Ô∏è –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤</div>`
      );
      return;
    }

    try {
      const resp = await fetch(
        `/api/v1/users/admin/users/${encodeURIComponent(userId)}/password`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: getAuthToken()
          },
          body: JSON.stringify({
            new_password: newPass,
            new_password_confirmation: newPass2
          })
        }
      );

      if (!resp.ok) {
        const txt = await resp.text();
        let msg = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å";
        try {
          const j = JSON.parse(txt);
          if (j.detail) msg = j.detail;
        } catch (e2) {
          if (txt) msg = txt;
        }
        throw new Error(msg);
      }

      showHTML(`
        <div class="card success fade-in">
          <h3>‚úÖ –ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω</h3>
          <p>–ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <b>${username}</b> —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</p>
        </div>
      `);
    } catch (err) {
      showHTML(
        `<div class="error">‚ùå –û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è: ${err.message}</div>`
      );
      console.error("Admin update password error:", err);
    }

    return;
  }

  if (delBtn) {
    if (!IS_ADMIN || !getAuthToken()) {
      showHTML(`<div class="warn">‚ö†Ô∏è –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è admin</div>`);
      return;
    }

    const userId = delBtn.dataset.id;
    const username = delBtn.dataset.username || "?";

    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}"?`)) {
      return;
    }

    try {
      const resp = await fetch(
        `/api/v1/users/admin/users/${encodeURIComponent(userId)}`,
        {
          method: "DELETE",
          headers: {
            Authorization: getAuthToken()
          }
        }
      );

      if (!resp.ok) {
        const txt = await resp.text();
        let msg = "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
        try {
          const j = JSON.parse(txt);
          if (j.detail) msg = j.detail;
        } catch (e2) {
          if (txt) msg = txt;
        }
        throw new Error(msg);
      }

      showHTML(`
        <div class="card success fade-in">
          <h3>‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω</h3>
          <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å <b>${username}</b> –±—ã–ª —É–¥–∞–ª—ë–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</p>
        </div>
      `);

      await loadAdminUsers();
    } catch (err) {
      showHTML(
        `<div class="error">‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${err.message}</div>`
      );
      console.error("Admin delete user error:", err);
    }
  }
});

--- static/catalog.js ---
import { fetchJSON, out, reflectAuthStatus, getAuthToken, cartAdd } from "./common.js";

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

function cardHtml(p) {
  return `
    <div class="card hover-raise product-card" data-id="${p.id}">
      <div class="card-head">
        <h3 style="margin:0;font-size:18px">
          ${escapeHtml(p.brand || "?")} ‚Äî ${escapeHtml(p.model || "?")}
        </h3>
      </div>
      <div class="mono">id: ${escapeHtml(p.id || "")}</div>
      <div>Category: <b>${escapeHtml(p.category || "-")}</b></div>
      <div>Price: <b class="price">${p.price ?? "-"}</b></div>

      <div class="actions">
        <button
          class="btn ghost action"
          data-act="like"
          data-id="${p.id}"
        >
          Like
        </button>

        <button
          class="btn outline action"
          data-act="unlike"
          data-id="${p.id}"
        >
          Unlike
        </button>

        <button
          class="btn success action"
          data-act="add"
          data-id="${p.id}"
          data-brand="${escapeHtml(p.brand || "")}"
          data-model="${escapeHtml(p.model || "")}"
          data-price="${p.price ?? ""}"
        >
          Add to Cart
        </button>
      </div>
    </div>
  `;
}



function renderProducts(items) {
  const wrap = document.getElementById("products");
  if (!wrap) return;
  if (!items.length) {
    wrap.innerHTML = `<div class="muted">–ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç –ø–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º</div>`;
    return;
  }
  wrap.innerHTML = items.map(cardHtml).join("");
}

function selectedCategories() {
  const w = document.getElementById("catFilters");
  if (!w) return [];
  return [...w.querySelectorAll('input[type="checkbox"]')]
    .filter((i) => i.checked)
    .map((i) => i.value.trim().toUpperCase());
}


async function reloadWithFilters() {
  const q = document.getElementById("searchInput")?.value.trim() || "";
  const cats = selectedCategories();

  try {
    let items = [];

    if (!q && !cats.length) {
      const data = await fetchJSON(`/api/v1/products`);
      items = Array.isArray(data) ? data : (data.items || []);
    }
    else if (q && cats.length) {
      const data = await fetchJSON(`/api/v1/search?q=${encodeURIComponent(q)}`);
      const all = data.items || [];
      const set = new Set(cats);
      items = all.filter(p => {
        const cat = (p.category || "").toString().toUpperCase();
        return !cat || set.has(cat);
      });
    }
    else if (q && !cats.length) {
      const data = await fetchJSON(`/api/v1/search?q=${encodeURIComponent(q)}`);
      items = data.items || [];
    }
    else if (!q && cats.length) {
      const csv = cats.join(",");
      const data = await fetchJSON(`/api/v1/products/by-category?category=${encodeURIComponent(csv)}`);
      items = data.items || [];
    }

    renderProducts(items);
    out({ search: q || null, categories: cats, count: items.length });

    await maybeLoadRecommendations();
  } catch (e) {
    out(e.message);
  }
}

async function maybeLoadRecommendations() {
  const list = document.getElementById("recoList");
  const hint = document.getElementById("recoHint");
  if (!list || !hint) return;

  list.innerHTML = `<div class="muted mono">Loading...</div>`;

  if (!getAuthToken()) {
    list.innerHTML = `<div class="muted">üîí –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>`;
    return;
  }

  try {
    const data = await fetchJSON(`/api/v1/users/me/recommendation`);

    let items = [];
    if (Array.isArray(data)) items = data;
    else if (Array.isArray(data.items)) items = data.items;
    else if (Array.isArray(data.data)) items = data.data;
    else if (Array.isArray(data.recommendations)) items = data.recommendations;

    if (!items.length) {
      hint.textContent = "–ü–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π";
      list.innerHTML = `<div class="muted">–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏ –ª–∞–π–∫–∞–π—Ç–µ —Ç–æ–≤–∞—Ä—ã, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>`;
      return;
    }

    list.innerHTML = items
      .map(
        (p) => `
        <div class="card fade-in">
          <div class="card-head">
            <div>
              <h4 style="margin:0">${escapeHtml(p.brand || "?")} ‚Äî ${escapeHtml(p.model || "?")}</h4>
              <div class="mono" style="font-size:11px;margin-top:2px;">
                id: ${escapeHtml(p.id || "").slice(0,8)}...
              </div>
            </div>
            <a class="btn ghost" href="/product.html?id=${encodeURIComponent(p.id)}" style="padding:6px 10px;font-size:12px;">Open</a>
          </div>
          <div class="muted" style="font-size:12px;margin-top:4px;">
            –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>${escapeHtml(p.category || "-")}</b> ¬∑ –¶–µ–Ω–∞: <b>${p.price ?? "-"}</b>
          </div>
        </div>`
      )
      .join("");

  } catch (e) {
    console.error("RECO ERROR:", e);
    hint.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π";
    list.innerHTML = `<div class="muted">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>`;
  }
}

document.addEventListener("click", async (e) => {
  const btn = e.target.closest("button.action");
  if (!btn) return;
  const act = btn.dataset.act;
  const pid = btn.dataset.id;

  try {
    if (act === "like") {
      const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "POST" });
      out(data);
    } else if (act === "unlike") {
      const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "DELETE" });
      out(typeof data === "string" ? data : "unliked (204)");
    } else if (act === "add") {
      const brand = btn.dataset.brand || "";
      const model = btn.dataset.model || "";
      const priceRaw = btn.dataset.price || "";
      const price = priceRaw === "" ? null : Number(priceRaw);
      cartAdd({ id: pid, brand, model, price });
      out(`Added to cart: ${brand} ‚Äî ${model}`);
    }
  } catch (err) {
    out(err.message);
  }
});

document.addEventListener("click", (e) => {
  if (e.target.closest("button.action")) return;

  const card = e.target.closest(".product-card");
  if (!card) return;

  const pid = card.dataset.id;
  if (!pid) return;

  window.location.href = `/product.html?id=${encodeURIComponent(pid)}`;
});


async function onSearch() {
  await reloadWithFilters();
}

async function applyCategoryFilter() {
  await reloadWithFilters();
}

function resetAllFilters() {
  const input = document.getElementById("searchInput");
  if (input) input.value = "";

  const w = document.getElementById("catFilters");
  if (w) w.querySelectorAll('input[type="checkbox"]').forEach((i) => (i.checked = false));

  reloadWithFilters().catch(console.error);
}


document.getElementById("btnSearch")?.addEventListener("click", onSearch);
document.getElementById("btnApplyCats")?.addEventListener("click", applyCategoryFilter);
document.getElementById("btnResetCats")?.addEventListener("click", resetAllFilters);

reflectAuthStatus();

reloadWithFilters().catch(console.error);
maybeLoadRecommendations().catch(console.error);

--- static/user.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore ‚Äî –ê–∫–∫–∞—É–Ω—Ç</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container wide fade-in">

  <section id="messagesPanel" class="panel fade-in" style="display:none;margin-top:24px;">
    <div class="panel-title">
      <h3>üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</h3>
    </div>
    <div id="pretty" class="pretty"></div>
  </section>

  <section class="panel" style="margin-top:30px;">
    <div class="panel-title">
      <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º</h2>
      <div class="muted">–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>
    </div>

    <div class="grid cols-2" style="gap:24px;">

      <div class="u-col" style="gap:24px;">

        <div class="card big fade-in"
             style="min-height:220px;display:flex;flex-direction:column;justify-content:space-between;">
          <div>
            <h3 style="margin:0 0 12px">üîê –í—Ö–æ–¥</h3>
            <div class="u-col">
              <input id="loginUser" class="input" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
              <input id="loginPass" class="input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
            </div>
          </div>
          <div class="btn-row" style="margin-top:10px;">
            <button id="btnLogin" class="btn">–í–æ–π—Ç–∏</button>
            <button id="btnLogout" class="btn ghost">–í—ã–π—Ç–∏</button>
          </div>
        </div>

        <div class="card big fade-in"
             style="min-height:220px;display:flex;flex-direction:column;justify-content:space-between;">
          <div>
            <h3 style="margin:0 0 12px">‚ú® –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <div class="u-col">
              <input id="regUser" class="input" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
              <input id="regPass" class="input" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
              <input id="regPass2" class="input" type="password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" />
            </div>
          </div>
          <button id="btnRegister" class="btn block" style="margin-top:10px;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>

        <div class="card big fade-in" id="adminUsersBox" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin:0">üë• –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (admin)</h3>
            <button id="btnReloadUsers" class="btn outline small">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
          <div id="adminUsersContent" style="max-height:400px;overflow-y:auto;">
            <div class="muted">–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é admin</div>
          </div>
        </div>

      </div>

      <div class="u-col" style="gap:24px;">

        <div class="card big fade-in">
          <h3 style="margin:0 0 12px">üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
          <div id="userInfo" class="u-col">
            <div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</div>
          </div>
        </div>

        <div class="card big fade-in">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin:0">üìú –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h3>
            <button id="btnHistory" class="btn outline small">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
          <div id="historyContent" style="max-height:400px;overflow-y:auto;">
            <div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>
          </div>
        </div>

        <div class="card big fade-in">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin:0">üõí –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</h3>
            <button id="btnPurchases" class="btn outline small">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
          <div id="purchasesContent" style="max-height:400px;overflow-y:auto%;">
            <div class="muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫</div>
          </div>
        </div>

      </div>
    </div>
  </section>
</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/user.js"></script>
</body>
</html>

--- static/header.js ---
function renderHeader() {
  const host = document.getElementById("site-header");
  if (!host) return;

  host.innerHTML = `
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand"><span class="logo"></span><a href="/" class="brand-link">DayStore</a></div>

        <nav class="topnav">
          <a href="/" data-nav="catalog">Browse</a>
          <a href="/user.html" data-nav="user">Account</a>
          <a href="/cart.html" data-nav="cart">Cart <span data-cart-count class="mono" style="margin-left:6px;background:rgba(255,255,255,.06);padding:2px 8px;border-radius:999px">0</span></a>
        </nav>
        <div class="status"><span class="dot"></span><span data-auth-status>anonymous</span></div>
      </div>
    </div>
  `;

  const map = {
    "/": "catalog",
    "/index.html": "catalog",
    "/product.html": "catalog",
    "/user.html": "user",
    "/cart.html": "cart",
  };
  const active = map[(location.pathname||"/").toLowerCase()] || "catalog";
  host.querySelectorAll(".topnav a").forEach(a=>{
    a.classList.toggle("active", a.dataset.nav===active);
  });
}
document.addEventListener("DOMContentLoaded", renderHeader);

--- static/common.js ---
const LS_AUTH = "AUTH";

export function getAuthToken() {
  return localStorage.getItem(LS_AUTH) || "";
}

export function setAuthToken(token) {
  if (token) {
    localStorage.setItem(LS_AUTH, token);
  } else {
    localStorage.removeItem(LS_AUTH);
  }
  reflectAuthStatus();
}

export function makeBasic(u, p) {
  return "Basic " + btoa(`${u}:${p}`);
}

export function reflectAuthStatus() {
  const s = document.querySelector("[data-auth-status]");
  if (s) {
    const tok = getAuthToken();
    s.textContent = tok ? "authorized" : "anonymous";
    const dot = document.querySelector(".status .dot");
    if (dot) dot.style.background = tok ? "var(--success)" : "#ffd166";
  }
  document
    .querySelectorAll("[data-cart-count]")
    .forEach((e) => (e.textContent = String(cartCount())));
}

function attachAuth(opts = {}) {
  const headers = opts.headers || {};
  const tok = getAuthToken();
  if (tok && !headers["Authorization"]) {
    headers["Authorization"] = tok;
  }
  return { ...opts, headers };
}

export async function fetchJSON(url, opts = {}) {
  const r = await fetch(url, attachAuth(opts));
  if (!r.ok) {
    const txt = await r.text();
    if (r.status === 401 || r.status === 403) {
      setAuthToken("");
      throw new Error("Unauthorized: go to Account and log in.");
    }
    throw new Error(`HTTP ${r.status}: ${txt}`);
  }
  const ct = r.headers.get("content-type") || "";
  return ct.includes("application/json") ? r.json() : r.text();
}

export function out(msg, id = "output") {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent =
    typeof msg === "string" ? msg : JSON.stringify(msg, null, 2);
}

const LS_CART = "CART_V1";

function readCart() {
  try {
    return JSON.parse(localStorage.getItem(LS_CART) || "[]");
  } catch {
    return [];
  }
}

function writeCart(items) {
  localStorage.setItem(LS_CART, JSON.stringify(items));
  reflectAuthStatus();
}

export function cartList() {
  return readCart();
}

export function cartCount() {
  return readCart().length;
}

export function cartAdd(item) {
  const xs = readCart();
  if (!xs.find((x) => x.id === item.id)) {
    xs.push(item);
    writeCart(xs);
  }
}

export function cartRemove(id) {
  writeCart(readCart().filter((x) => x.id !== id));
}

export function cartClear() {
  writeCart([]);
}

document.addEventListener("DOMContentLoaded", reflectAuthStatus);


--- static/cart.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore ‚Äî Cart</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container narrow">
  <section class="panel">
    <h2 style="margin:0 0 12px">Your Cart</h2>
    <div id="cartList"></div>
    <div class="actions" style="margin-top:12px">
      <button id="btnCheckout" class="btn success">Checkout</button>
      <button id="btnClear" class="btn ghost">Clear</button>
    </div>
  </section>
  <section>
    <h3>Console</h3>
    <pre id="output" class="log"></pre>
  </section>
</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/cart.js"></script>
</body>
</html>

--- static/product.js ---
import { fetchJSON, out, getAuthToken, cartAdd } from "./common.js";

function isLoggedIn(){ return !!getAuthToken(); }
function getId(){ return new URL(location.href).searchParams.get("id") || ""; }

function skeleton(id){
  const box = document.getElementById("productBox");
  box.innerHTML = `
    <div class="big card">
      <div class="card-head">
        <h2 id="pTitle" style="margin:0">Loading‚Ä¶</h2>
        <div class="mono">id: ${id}</div>
      </div>
      <div id="pInfo" class="kv" style="margin-top:10px">
        <div><span>Category</span><b>‚Äî</b></div>
        <div><span>Price</span><b>‚Äî</b></div>
        <div><span>Status</span><b id="pStatus" class="muted">Waiting server‚Ä¶</b></div>
      </div>
      <div class="actions" style="margin-top:14px">
        <!-- –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ Like / Unlike / Add to Cart -->
        <button class="btn ${isLoggedIn() ? "" : "ghost"} need-auth" data-act="like">Like</button>
        <button class="btn ghost need-auth" data-act="unlike">Unlike</button>
        <button class="btn outline need-auth" data-act="cart" data-brand="" data-model="" data-price="">
          Add to Cart
        </button>
      </div>
    </div>
  `;
  reflectAuth();
}

function reflectAuth(){
  document.querySelectorAll(".need-auth").forEach(b=>{
    if(isLoggedIn()){
      b.removeAttribute("disabled");
      b.classList.remove("ghost");
    } else {
      b.setAttribute("disabled","disabled");
      b.classList.add("ghost");
    }
  });
}

function hydrate(p){
  document.getElementById("pTitle").textContent = `${p.brand||"?"} ‚Äî ${p.model||"?"}`;
  document.getElementById("pInfo").innerHTML = `
    <div><span>Category</span><b>${p.category || "-"}</b></div>
    <div><span>Price</span><b>${p.price ?? "-"}</b></div>
    <div><span>Status</span><b class="muted">Ready</b></div>
  `;
  const btnCart = document.querySelector('button[data-act="cart"]');
  if(btnCart){
    btnCart.dataset.brand = p.brand||"";
    btnCart.dataset.model = p.model||"";
    btnCart.dataset.price = p.price ?? "";
  }
}
function notFound(){
  document.getElementById("pTitle").textContent = "Product not found";
  const s = document.getElementById("pStatus");
  if(s) s.textContent="Check product id";
}

async function load(){
  const id = getId();
  if(!id){ out("No product id specified"); return; }
  skeleton(id);
  try{
    const data = await fetchJSON(`/api/v1/products/${encodeURIComponent(id)}`);
    hydrate(data);
  }
  catch(e){
    notFound();
    out(e.message);
  }
}

document.addEventListener("click", async (e)=>{
  const btn = e.target.closest("button.btn");
  if(!btn) return;
  const act = btn.dataset.act;
  const id = getId();

  try{
    if(act==="like"){
      if(!isLoggedIn()) return out("Login required");
      const data = await fetchJSON(`/api/v1/products/${id}/like`, {method:"POST"});
      out(data);
    }else if(act==="unlike"){
      if(!isLoggedIn()) return out("Login required");
      const res = await fetchJSON(`/api/v1/products/${id}/like`, {method:"DELETE"});
      out(typeof res==="string" ? res : "unliked (204)");
    }else if(act==="cart"){
      if(!isLoggedIn()) return out("Login required");
      cartAdd({
        id,
        brand: btn.dataset.brand || "",
        model: btn.dataset.model || "",
        price: btn.dataset.price ? Number(btn.dataset.price) : null
      });
      out("Added to cart");
    }
  }catch(err){
    out(err.message);
  }
});

window.addEventListener("storage", ev=>{
  if(ev.key==="AUTH"){
    reflectAuth();
  }
});

document.addEventListener("DOMContentLoaded", load);

--- static/app.js ---
(function () {

  const out = (msg) => {
    const el = document.getElementById("output");
    el.textContent = (typeof msg === "string") ? msg : JSON.stringify(msg, null, 2);
  };


  function getAuthToken() { return localStorage.getItem("AUTH") || ""; }
  function setAuthToken(token) {
    if (token) localStorage.setItem("AUTH", token);
    else localStorage.removeItem("AUTH");
    reflectAuthStatus();
    updateControlsState();
  }
  function makeBasic(u, p) { return "Basic " + btoa(`${u}:${p}`); }

  function reflectAuthStatus() {
    const span = document.getElementById("authStatus");
    const tok = getAuthToken();
    if (!span) return;
    if (!tok) { span.textContent = "anonymous"; span.style.color = "#ffd166"; }
    else { span.textContent = "authorized"; span.style.color = "#06d6a0"; }
  }

  function updateControlsState() {
    const authed = !!getAuthToken();
    const btnWho = document.getElementById("btnWhoAmI");
    const btnHist = document.getElementById("btnHistory");
    const actions = document.querySelectorAll("button.action");

    if (btnWho) btnWho.disabled = !authed;
    if (btnHist) btnHist.disabled = !authed;

    actions.forEach(b => {
      const act = b.dataset.act;
      b.disabled = (act !== "view" && !authed);
    });
  }


  async function fetchJSON(url, opts = {}) {
    opts.headers = opts.headers || {};
    const auth = getAuthToken();
    if (auth && !opts.headers["Authorization"]) {
      opts.headers["Authorization"] = auth;
    }
    const r = await fetch(url, opts);
    if (!r.ok) {
      const txt = await r.text();
      if (r.status === 401 || r.status === 403) {
        throw new Error("Unauthorized: –≤–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å (Basic)");
      }
      throw new Error(`HTTP ${r.status}: ${txt}`);
    }
    const ct = r.headers.get("content-type") || "";
    return ct.includes("application/json") ? r.json() : r.text();
  }

  async function loadProducts() {
    try {
      const useCache = getAuthToken() ? "false" : "true";
      const data = await fetchJSON(`/api/v1/products?use_cache=${useCache}`);
      renderProducts(data.items || []);
      updateControlsState();
    } catch (e) {
      out(e.message);
    }
  }

  function renderProducts(items) {
    const wrap = document.getElementById("products");
    if (!wrap) return;
    wrap.innerHTML = "";
    items.forEach(p => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3>${p.brand || "?"} ‚Äî ${p.model || "?"}</h3>
        <div class="mono">id: ${p.id}</div>
        <div>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>${p.category || "-"}</b></div>
        <div>–¶–µ–Ω–∞: <b>${p.price ?? "-"}</b></div>
        <div class="actions">
          <button class="action" data-act="view" data-id="${p.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
          <button class="action" data-act="like" data-id="${p.id}">Like</button>
          <button class="action" data-act="unlike" data-id="${p.id}">Unlike</button>
          <button class="action" data-act="buy" data-id="${p.id}">Buy</button>
        </div>
      `;
      wrap.appendChild(card);
    });
  }

  async function onAction(e) {
    const btn = e.target.closest("button.action");
    if (!btn) return;
    const act = btn.dataset.act;
    const pid = btn.dataset.id;

    if ((act === "like" || act === "unlike" || act === "buy") && !getAuthToken()) {
      out("Unauthorized: —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ (Basic)");
      return;
    }

    try {
      if (act === "view") {
        const data = await fetchJSON(`/api/v1/products/${pid}`);
        out(data);
      } else if (act === "like") {
        const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "POST" });
        out(data);
      } else if (act === "unlike") {
        const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "DELETE" });
        out(data);
      } else if (act === "buy") {
        const data = await fetchJSON(`/api/v1/products/${pid}/buy`, { method: "POST" });
        out(data);
      }
    } catch (err) {
      out(err.message);
    }
  }

  async function onSearch() {
    const inp = document.getElementById("searchInput");
    const q = inp ? inp.value.trim() : "";
    try {
      const data = await fetchJSON(`/api/v1/search?q=${encodeURIComponent(q)}`);
      renderProducts(data.items || []);
      out({ search: q, count: data.count });
      updateControlsState();
    } catch (e) {
      out(e.message);
    }
  }


  async function onRegister() {
    const u = document.getElementById("authUser")?.value.trim();
    const p = document.getElementById("authPass")?.value;
    if (!u || !p) return out("–í–≤–µ–¥–∏—Ç–µ username –∏ password –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏");
    try {
      const res = await fetchJSON(`/api/v1/users/registration`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: u, password: p, passwordConfirmation: p })
      });
      out(res);
    } catch (e) {
      out(e.message);
    }
  }

  async function onLogin() {
    const u = document.getElementById("authUser")?.value.trim();
    const p = document.getElementById("authPass")?.value;
    if (!u || !p) return out("–í–≤–µ–¥–∏—Ç–µ username –∏ password –¥–ª—è –ª–æ–≥–∏–Ω–∞");
    const token = makeBasic(u, p);
    try {
      const r = await fetch(`/api/v1/users/me/username`, { headers: { "Authorization": token } });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`Login failed: HTTP ${r.status}: ${txt}`);
      }
      const txt = await r.text();
      setAuthToken(token);
      out({ login: "ok", whoami: txt.trim() });
      await loadProducts();
    } catch (e) {
      setAuthToken("");
      out(e.message);
    }
  }

  function onLogout() {
    setAuthToken("");
    out("logged out");
    updateControlsState();
  }

  async function whoAmI() {
    if (!getAuthToken()) { out("Unauthorized: –≤–æ–π–¥–∏—Ç–µ (Basic)"); return; }
    try {
      const data = await fetchJSON(`/api/v1/users/me/username`);
      out(data);
    } catch (e) {
      out(e.message);
    }
  }

  async function myHistory() {
    if (!getAuthToken()) { out("Unauthorized: –≤–æ–π–¥–∏—Ç–µ (Basic)"); return; }
    try {
      const data = await fetchJSON(`/api/v1/users/me/history?all=true`);
      out(data);
    } catch (e) {
      out(e.message);
    }
  }


  document.addEventListener("DOMContentLoaded", () => {

    document.addEventListener("click", onAction);

    document.getElementById("btnSearch")?.addEventListener("click", onSearch);
    document.getElementById("btnRegister")?.addEventListener("click", onRegister);
    document.getElementById("btnLogin")?.addEventListener("click", onLogin);
    document.getElementById("btnLogout")?.addEventListener("click", onLogout);
    document.getElementById("btnWhoAmI")?.addEventListener("click", whoAmI);
    document.getElementById("btnHistory")?.addEventListener("click", myHistory);

    reflectAuthStatus();
    loadProducts().finally(updateControlsState);
  });

})();
