day-store
â”œâ”€â”€ .env
â”œâ”€â”€ .git
â”‚   â”œâ”€â”€ COMMIT_EDITMSG
â”‚   â”œâ”€â”€ HEAD
â”‚   â”œâ”€â”€ ORIG_HEAD
â”‚   â”œâ”€â”€ config
â”‚   â”œâ”€â”€ description
â”‚   â”œâ”€â”€ hooks
â”‚   â”‚   â”œâ”€â”€ applypatch-msg.sample
â”‚   â”‚   â”œâ”€â”€ commit-msg.sample
â”‚   â”‚   â”œâ”€â”€ fsmonitor-watchman.sample
â”‚   â”‚   â”œâ”€â”€ post-update.sample
â”‚   â”‚   â”œâ”€â”€ pre-applypatch.sample
â”‚   â”‚   â”œâ”€â”€ pre-commit.sample
â”‚   â”‚   â”œâ”€â”€ pre-merge-commit.sample
â”‚   â”‚   â”œâ”€â”€ pre-push.sample
â”‚   â”‚   â”œâ”€â”€ pre-rebase.sample
â”‚   â”‚   â”œâ”€â”€ pre-receive.sample
â”‚   â”‚   â”œâ”€â”€ prepare-commit-msg.sample
â”‚   â”‚   â”œâ”€â”€ push-to-checkout.sample
â”‚   â”‚   â”œâ”€â”€ sendemail-validate.sample
â”‚   â”‚   â””â”€â”€ update.sample
â”‚   â”œâ”€â”€ index
â”‚   â”œâ”€â”€ info
â”‚   â”‚   â””â”€â”€ exclude
â”‚   â”œâ”€â”€ logs
â”‚   â”‚   â”œâ”€â”€ HEAD
â”‚   â”‚   â””â”€â”€ refs
â”‚   â”‚       â”œâ”€â”€ heads
â”‚   â”‚       â”‚   â””â”€â”€ main
â”‚   â”‚       â””â”€â”€ remotes
â”‚   â”‚           â””â”€â”€ origin
â”‚   â”‚               â”œâ”€â”€ HEAD
â”‚   â”‚               â””â”€â”€ main
â”‚   â”œâ”€â”€ objects
â”‚   â”‚   â”œâ”€â”€ 05
â”‚   â”‚   â”‚   â””â”€â”€ 0fa14de7ba49b116f153a85b4f5ae67c984d10
â”‚   â”‚   â”œâ”€â”€ 10
â”‚   â”‚   â”‚   â””â”€â”€ de5acba7f6644cca674f8ada41ed12adbab720
â”‚   â”‚   â”œâ”€â”€ 13
â”‚   â”‚   â”‚   â””â”€â”€ af50f8601093a73ce50b1783c9d4b7a73f306f
â”‚   â”‚   â”œâ”€â”€ 26
â”‚   â”‚   â”‚   â””â”€â”€ e6b99187a01a47bffda31c2387779dee818d5c
â”‚   â”‚   â”œâ”€â”€ 27
â”‚   â”‚   â”‚   â””â”€â”€ b9759bdb254f698356aec03a90f5e2a5f5071a
â”‚   â”‚   â”œâ”€â”€ 2d
â”‚   â”‚   â”‚   â””â”€â”€ 04b315afda0b4c228593ae554170984a5314b8
â”‚   â”‚   â”œâ”€â”€ 2f
â”‚   â”‚   â”‚   â””â”€â”€ 1659db451b54fcc15566e4f97271ea286d36bb
â”‚   â”‚   â”œâ”€â”€ 31
â”‚   â”‚   â”‚   â””â”€â”€ 337edd8d546cc81de53c6d4d716c81bfecc001
â”‚   â”‚   â”œâ”€â”€ 3b
â”‚   â”‚   â”‚   â””â”€â”€ f5c8fc56cf3845cad42c4d86e48671cbd09114
â”‚   â”‚   â”œâ”€â”€ 42
â”‚   â”‚   â”‚   â””â”€â”€ 04b737df205080ebcea7dc780ae521e07f702c
â”‚   â”‚   â”œâ”€â”€ 55
â”‚   â”‚   â”‚   â””â”€â”€ 62aa2fb4f883d7b047942689da77cd43aa265f
â”‚   â”‚   â”œâ”€â”€ 58
â”‚   â”‚   â”‚   â””â”€â”€ 3c590cec0900265d8e14325b650d1f2f2cd43d
â”‚   â”‚   â”œâ”€â”€ 5e
â”‚   â”‚   â”‚   â””â”€â”€ 24dc2492fcf5bcd86bd12e0b547120c1f74117
â”‚   â”‚   â”œâ”€â”€ 5f
â”‚   â”‚   â”‚   â””â”€â”€ fb65c08fa4e878783c5428947a44c02048b831
â”‚   â”‚   â”œâ”€â”€ 60
â”‚   â”‚   â”‚   â””â”€â”€ ee288772c0a6d4e3f25bb9aee5486d34affea1
â”‚   â”‚   â”œâ”€â”€ 6d
â”‚   â”‚   â”‚   â””â”€â”€ bcf0aa452de8712417f8fc0912572cfd385075
â”‚   â”‚   â”œâ”€â”€ 6f
â”‚   â”‚   â”‚   â”œâ”€â”€ 15e74941c7360537d620b238dd316304c76895
â”‚   â”‚   â”‚   â””â”€â”€ aab6a21e8aaa066d5d5860d4f0b7f824b305f8
â”‚   â”‚   â”œâ”€â”€ 85
â”‚   â”‚   â”‚   â””â”€â”€ 89d315367460036826afe8584c86f58b8bed75
â”‚   â”‚   â”œâ”€â”€ 86
â”‚   â”‚   â”‚   â””â”€â”€ f852f122575fc3ac555cfa139947dfdf6ae052
â”‚   â”‚   â”œâ”€â”€ 89
â”‚   â”‚   â”‚   â””â”€â”€ b9f791fdd31cd867964b0da5896f95ae45640b
â”‚   â”‚   â”œâ”€â”€ 93
â”‚   â”‚   â”‚   â””â”€â”€ d1ac2f4df67db4f1445780a5d3cfdf7b3a0f2c
â”‚   â”‚   â”œâ”€â”€ 97
â”‚   â”‚   â”‚   â””â”€â”€ 112ca541ce7a3becf6c1ce692ed370f5990f25
â”‚   â”‚   â”œâ”€â”€ a0
â”‚   â”‚   â”‚   â””â”€â”€ 705f815b0a6f9dc85f2167e6cb45a02a79f811
â”‚   â”‚   â”œâ”€â”€ a3
â”‚   â”‚   â”‚   â””â”€â”€ 322fa4622ac4049661027641b1bd720bb07ee9
â”‚   â”‚   â”œâ”€â”€ ad
â”‚   â”‚   â”‚   â”œâ”€â”€ 0e39f4863ed703b471dd8d5a30a0c149cc2d03
â”‚   â”‚   â”‚   â””â”€â”€ 5da33e24a9f7b6e3b0746c6b351090c9fe33e1
â”‚   â”‚   â”œâ”€â”€ b1
â”‚   â”‚   â”‚   â”œâ”€â”€ 393be9e1fdf23c36405719e0a0edb51cdf8e1e
â”‚   â”‚   â”‚   â””â”€â”€ 8d6705dc67d6eafea7cc92a96f5810041e5feb
â”‚   â”‚   â”œâ”€â”€ b5
â”‚   â”‚   â”‚   â””â”€â”€ 70544247f588b3bdb71d526a1e5913eb397d27
â”‚   â”‚   â”œâ”€â”€ c1
â”‚   â”‚   â”‚   â””â”€â”€ 26b7749323a31561c3432a4071c2d1a01e7bee
â”‚   â”‚   â”œâ”€â”€ c9
â”‚   â”‚   â”‚   â””â”€â”€ e01c0cfe66d8223ead7b9eabe26a16339de104
â”‚   â”‚   â”œâ”€â”€ cc
â”‚   â”‚   â”‚   â””â”€â”€ fa263ef6a3395d15be26d4ba00879cf3b3995c
â”‚   â”‚   â”œâ”€â”€ d1
â”‚   â”‚   â”‚   â””â”€â”€ 7d24485f34c0c8b1030fc290775f7784d143a0
â”‚   â”‚   â”œâ”€â”€ dc
â”‚   â”‚   â”‚   â”œâ”€â”€ 42c988285eb0a0fa4dcfdaa2c992e1da99b128
â”‚   â”‚   â”‚   â””â”€â”€ 890fae206d11bf1838636210561632802f0a1b
â”‚   â”‚   â”œâ”€â”€ e2
â”‚   â”‚   â”‚   â””â”€â”€ 8cee19bacd8ad496f0ca3fb7a3f691509759a2
â”‚   â”‚   â”œâ”€â”€ e7
â”‚   â”‚   â”‚   â””â”€â”€ 17f7075ee6cf23edbb60b3c0af2dfdb0cccec7
â”‚   â”‚   â”œâ”€â”€ e8
â”‚   â”‚   â”‚   â””â”€â”€ 8e0fd6ec2988c953d92ce0363756bb754f1fc0
â”‚   â”‚   â”œâ”€â”€ ea
â”‚   â”‚   â”‚   â””â”€â”€ e488d42a6545e3c34a2b5085b64af051c83e46
â”‚   â”‚   â”œâ”€â”€ ee
â”‚   â”‚   â”‚   â””â”€â”€ 49170bd2010a25619a356026895ab51cf3dd26
â”‚   â”‚   â”œâ”€â”€ ef
â”‚   â”‚   â”‚   â””â”€â”€ f5e907a9a82dae8f6721c94a2306198b386aae
â”‚   â”‚   â”œâ”€â”€ f2
â”‚   â”‚   â”‚   â””â”€â”€ a34826489ff10310fb86aef4073a16e2d66f44
â”‚   â”‚   â”œâ”€â”€ f3
â”‚   â”‚   â”‚   â”œâ”€â”€ 5cc2eb59062864d7594fa3a838f89914ba9394
â”‚   â”‚   â”‚   â””â”€â”€ c22673b1af3e7dddf4c707718ae0870438e4ee
â”‚   â”‚   â”œâ”€â”€ fd
â”‚   â”‚   â”‚   â””â”€â”€ f326638eba373f0b483a502ca1f73e3994a6ad
â”‚   â”‚   â”œâ”€â”€ info
â”‚   â”‚   â””â”€â”€ pack
â”‚   â”‚       â”œâ”€â”€ pack-5bd910fa05916d1c5d5c0b1980cacbe1d1624b33.idx
â”‚   â”‚       â”œâ”€â”€ pack-5bd910fa05916d1c5d5c0b1980cacbe1d1624b33.pack
â”‚   â”‚       â””â”€â”€ pack-5bd910fa05916d1c5d5c0b1980cacbe1d1624b33.rev
â”‚   â”œâ”€â”€ packed-refs
â”‚   â””â”€â”€ refs
â”‚       â”œâ”€â”€ heads
â”‚       â”‚   â””â”€â”€ main
â”‚       â”œâ”€â”€ remotes
â”‚       â”‚   â””â”€â”€ origin
â”‚       â”‚       â”œâ”€â”€ HEAD
â”‚       â”‚       â””â”€â”€ main
â”‚       â””â”€â”€ tags
â”œâ”€â”€ .idea
â”‚   â”œâ”€â”€ .gitignore
â”‚   â”œâ”€â”€ fastapi-reco.iml
â”‚   â”œâ”€â”€ inspectionProfiles
â”‚   â”‚   â”œâ”€â”€ Project_Default.xml
â”‚   â”‚   â””â”€â”€ profiles_settings.xml
â”‚   â”œâ”€â”€ misc.xml
â”‚   â”œâ”€â”€ modules.xml
â”‚   â”œâ”€â”€ vcs.xml
â”‚   â””â”€â”€ workspace.xml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ app
â”‚   â”œâ”€â”€ __pycache__
â”‚   â”‚   â”œâ”€â”€ main.cpython-313.pyc
â”‚   â”‚   â””â”€â”€ models.cpython-313.pyc
â”‚   â”œâ”€â”€ core
â”‚   â”‚   â”œâ”€â”€ __pycache__
â”‚   â”‚   â”‚   â”œâ”€â”€ config.cpython-313.pyc
â”‚   â”‚   â”‚   â”œâ”€â”€ db.cpython-313.pyc
â”‚   â”‚   â”‚   â””â”€â”€ security.cpython-313.pyc
â”‚   â”‚   â”œâ”€â”€ config.py
â”‚   â”‚   â”œâ”€â”€ db.py
â”‚   â”‚   â””â”€â”€ security.py
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ models.py
â”‚   â””â”€â”€ routers
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ __pycache__
â”‚       â”‚   â”œâ”€â”€ __init__.cpython-313.pyc
â”‚       â”‚   â”œâ”€â”€ categories.cpython-313.pyc
â”‚       â”‚   â”œâ”€â”€ health.cpython-313.pyc
â”‚       â”‚   â”œâ”€â”€ products.cpython-313.pyc
â”‚       â”‚   â”œâ”€â”€ search.cpython-313.pyc
â”‚       â”‚   â””â”€â”€ users.cpython-313.pyc
â”‚       â”œâ”€â”€ categories.py
â”‚       â”œâ”€â”€ health.py
â”‚       â”œâ”€â”€ products.py
â”‚       â”œâ”€â”€ search.py
â”‚       â””â”€â”€ users.py
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ project_structure.txt
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ static
â”‚   â”œâ”€â”€ app.js
â”‚   â”œâ”€â”€ cart.html
â”‚   â”œâ”€â”€ cart.js
â”‚   â”œâ”€â”€ catalog.js
â”‚   â”œâ”€â”€ common.js
â”‚   â”œâ”€â”€ header.js
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ product.html
â”‚   â”œâ”€â”€ product.js
â”‚   â”œâ”€â”€ styles.css
â”‚   â”œâ”€â”€ user.html
â”‚   â””â”€â”€ user.js
â””â”€â”€ x.py


# Files content (only from 'app' and 'static' folders)


--- app/models.py ---
from datetime import datetime
from enum import Enum
from typing import Optional, List

from pydantic import BaseModel, Field


class Category(str, Enum):
    LAPTOP = "LAPTOP"
    PC = "PC"
    HEADPHONE = "HEADPHONE"
    SMART_WATCH = "SMART_WATCH"
    CAMERA = "CAMERA"
    PHONE = "PHONE"


class ActionEnum(str, Enum):
    VIEW = "VIEW"
    LIKE = "LIKE"
    PURCHASE = "PURCHASE"

class UserRegister(BaseModel):
    username: str
    password: str
    passwordConfirmation: str


class UserInDB(BaseModel):
    id: str
    username: str
    password: str


class UserPublic(BaseModel):
    id: str
    username: str


class ProductIn(BaseModel):
    brand: Optional[str] = None
    model: Optional[str] = None
    price: Optional[int] = None
    category: Optional[Category] = None


class ProductOut(ProductIn):
    id: str


class UserActionOut(BaseModel):
    id: Optional[str] = None
    userId: str
    action: ActionEnum
    productId: Optional[str] = None
    category: Optional[Category] = None
    timestamp: datetime = Field(..., alias="timestamp")

--- app/main.py ---
from fastapi import FastAPI
import uvicorn

from fastapi.middleware.cors import CORSMiddleware
from starlette.staticfiles import StaticFiles

from app.core.config import settings
from app.core.security import ensure_service_user
from app.routers import health, users, products, categories, search


app = FastAPI(
    title="DayStore Backend (FastAPI)",
    version="1.0.0",
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)


@app.on_event("startup")
async def on_startup():
    await ensure_service_user()

app.include_router(health.router)
app.include_router(users.router)
app.include_router(products.router)
app.include_router(categories.router)
app.include_router(search.router)

app.mount("/", StaticFiles(directory="static", html=True), name="static")


if __name__ == "__main__":
    uvicorn.run("app.main:app", host="0.0.0.0", port=settings.port, reload=True)

--- app/routers/users.py ---
from datetime import datetime
from typing import List, Optional, Dict

from fastapi import APIRouter, Depends, HTTPException, Query
from fastapi.responses import PlainTextResponse
from bson import ObjectId

from app.core.db import users_coll, actions_coll, products_coll
from app.core.security import hash_password, verify_password, get_current_user
from app.models import (
    UserRegister,
    UserPublic,
    UserInDB,
    UserActionOut,
    ActionEnum,
    ProductOut,
    Category,
)

router = APIRouter(prefix="/api/v1/users", tags=["users"])


@router.post("/registration", response_model=UserPublic)
async def register_user(body: UserRegister):
    """
    Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¹
    """
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¹
    if body.password != body.passwordConfirmation:
        raise HTTPException(status_code=400, detail="Passwords do not match")

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ»Ğ¸Ğ½Ñ‹ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
    if len(body.password) < 6:
        raise HTTPException(status_code=400, detail="Password must be at least 6 characters")

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ»Ğ¸Ğ½Ñ‹ username
    if len(body.username.strip()) < 3:
        raise HTTPException(status_code=400, detail="Username must be at least 3 characters")

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    existing = await users_coll.find_one({"username": body.username.strip()})
    if existing:
        raise HTTPException(status_code=400, detail="Username already exists")

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ Ñ…ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»ĞµĞ¼
    doc = {
        "username": body.username.strip(),
        "password": hash_password(body.password),
        "created_at": datetime.utcnow()
    }

    res = await users_coll.insert_one(doc)

    return UserPublic(id=str(res.inserted_id), username=body.username.strip())


@router.post("/login")
async def login_user(username: str, password: str):
    """
    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    """
    if not username or not password:
        raise HTTPException(status_code=400, detail="Username and password required")

    # ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    user_doc = await users_coll.find_one({"username": username.strip()})
    if not user_doc:
        raise HTTPException(status_code=401, detail="Invalid username or password")

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
    if not verify_password(password, user_doc["password"]):
        raise HTTPException(status_code=401, detail="Invalid username or password")

    return {
        "id": str(user_doc["_id"]),
        "username": user_doc["username"],
        "message": "Login successful"
    }


@router.get("/me", response_model=UserPublic)
async def get_me(user: UserInDB = Depends(get_current_user)):
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ
    """
    return UserPublic(id=user.id, username=user.username)


@router.get("/me/username", response_class=PlainTextResponse)
async def get_me_username(user: UserInDB = Depends(get_current_user)):
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ username Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    """
    return user.username


@router.post("/me/update/username", response_model=UserPublic)
async def update_username(new_username: str, user: UserInDB = Depends(get_current_user)):
    """
    ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ username Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    """
    if not new_username.strip():
        raise HTTPException(status_code=400, detail="Username cannot be empty")

    if len(new_username.strip()) < 3:
        raise HTTPException(status_code=400, detail="Username must be at least 3 characters")

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°, Ñ‡Ñ‚Ğ¾ username Ğ½Ğµ Ğ·Ğ°Ğ½ÑÑ‚ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼
    existing = await users_coll.find_one({"username": new_username.strip()})
    if existing and str(existing["_id"]) != user.id:
        raise HTTPException(status_code=400, detail="Username already exists")

    # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ username
    await users_coll.update_one(
        {"_id": ObjectId(user.id)},
        {"$set": {"username": new_username.strip(), "updated_at": datetime.utcnow()}},
    )

    return UserPublic(id=user.id, username=new_username.strip())


@router.get("/me/history", response_model=List[UserActionOut])
async def me_history(
        all: bool = Query(True),
        limit: Optional[int] = Query(None, ge=1, le=500),
        user: UserInDB = Depends(get_current_user),
):
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    """
    q: Dict = {"userId": user.id}
    if not all:
        q["action"] = {"$ne": ActionEnum.VIEW.value}

    cursor = actions_coll.find(q).sort("timestamp", -1)
    if limit:
        cursor = cursor.limit(limit)

    docs = await cursor.to_list(length=limit or 500)
    out: List[UserActionOut] = []
    for d in docs:
        out.append(
            UserActionOut(
                id=str(d.get("_id")),
                userId=d["userId"],
                action=d["action"],
                productId=d.get("productId"),
                category=d.get("category"),
                timestamp=d.get("timestamp", datetime.utcnow()),
            )
        )
    return out


def _weight(action: str) -> int:
    """Ğ’ĞµÑ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ² Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹"""
    if action == ActionEnum.VIEW.value:
        return 1
    if action == ActionEnum.LIKE.value:
        return 3
    if action == ActionEnum.PURCHASE.value:
        return 5
    return 0


@router.get("/me/recommendation", response_model=List[ProductOut])
async def me_recommendation(
        limit: int = Query(10, ge=1, le=100),
        user: UserInDB = Depends(get_current_user),
):
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¹ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
    """
    acts = await actions_coll.find({"userId": user.id}).to_list(length=1000)
    if not acts:
        return []

    product_scores: Dict[str, float] = {}
    category_scores: Dict[str, float] = {}

    # ĞŸĞ¾Ğ´ÑÑ‡ĞµÑ‚ Ğ²ĞµÑĞ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¾Ğ² Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹
    for a in acts:
        w = _weight(a["action"])
        pid = a.get("productId")
        cat = a.get("category")
        if pid:
            product_scores[pid] = product_scores.get(pid, 0.0) + w
        if cat:
            category_scores[cat] = category_scores.get(cat, 0.0) + w

    all_products = await products_coll.find({}).to_list(length=1000)
    scored: List[tuple] = []

    for p in all_products:
        pid = str(p["_id"])
        base = product_scores.get(pid, 0.0)
        cat = p.get("category")
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²ĞµÑ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸
        base += 0.5 * category_scores.get(cat, 0.0)
        if base <= 0:
            continue
        scored.append((base, p))

    # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾ Ğ²ĞµÑÑƒ
    scored.sort(key=lambda x: x[0], reverse=True)
    top = [p for _, p in scored[:limit]]

    res: List[ProductOut] = []
    for d in top:
        res.append(
            ProductOut(
                id=str(d["_id"]),
                brand=d.get("brand"),
                model=d.get("model"),
                price=d.get("price"),
                category=d.get("category"),
            )
        )
    return res
--- app/routers/health.py ---
from fastapi import APIRouter

router = APIRouter(prefix="/api/v1/health", tags=["health"])

@router.get("")
async def health():
    return {"status": "ok"}

--- app/routers/categories.py ---
from fastapi import APIRouter
from app.models import Category

router = APIRouter(prefix="/api/v1/categories", tags=["categories"])

@router.get("/")
async def list_categories():
    return [c.value for c in Category]

--- app/routers/__init__.py ---
from . import health, users, products

--- app/routers/products.py ---
from datetime import datetime
from typing import List, Optional

from fastapi import APIRouter, Depends, HTTPException, Query, Request
from bson import ObjectId
from pydantic import BaseModel

from app.core.db import products_coll, actions_coll
from app.core.security import get_current_user
from app.models import ProductOut, Category, ActionEnum, UserInDB

router = APIRouter(prefix="/api/v1/products", tags=["products"])

class ProductsResponse(BaseModel):
    count: int
    items: List[ProductOut]

async def _find_product_doc(product_id: str):
    doc = await products_coll.find_one({"_id": product_id})
    if doc:
        return doc
    if ObjectId.is_valid(product_id):
        doc = await products_coll.find_one({"_id": ObjectId(product_id)})
    return doc

def _product_out(doc) -> ProductOut:
    return ProductOut(
        id=str(doc["_id"]),
        brand=doc.get("brand"),
        model=doc.get("model"),
        price=doc.get("price"),
        category=doc.get("category"),
    )


@router.get("/", response_model=List[ProductOut])
async def list_products():
    docs = await products_coll.find({}).to_list(length=1000)
    if not docs:
        raise HTTPException(status_code=404, detail="No products found")
    return [_product_out(d) for d in docs]


@router.get("/by-category", response_model=ProductsResponse)
async def products_by_category(
    category: str = Query(..., description="CSV: LAPTOP,PHONE,..."),
):
    cats = [c.strip().upper() for c in category.split(",") if c.strip()]
    q = {"category": {"$in": cats}} if cats else {}
    docs = await products_coll.find(q).to_list(length=1000)
    items = [_product_out(d) for d in docs]
    return ProductsResponse(count=len(items), items=items)


@router.get("/by-brand", response_model=List[ProductOut])
async def products_by_brand(brand: str):
    docs = await products_coll.find({"brand": brand}).to_list(length=1000)
    return [_product_out(d) for d in docs]


@router.get("/by-model", response_model=List[ProductOut])
async def products_by_model(model: str):
    docs = await products_coll.find({"model": model}).to_list(length=1000)
    return [_product_out(d) for d in docs]


@router.get("/by-price", response_model=List[ProductOut])
async def products_by_price(
    min: Optional[int] = Query(None, ge=0),
    max: Optional[int] = Query(None, ge=0),
):
    q = {}
    if min is not None or max is not None:
        q["price"] = {}
        if min is not None:
            q["price"]["$gte"] = min
        if max is not None:
            q["price"]["$lte"] = max
    docs = await products_coll.find(q).to_list(length=1000)
    return [_product_out(d) for d in docs]


@router.get("/{product_id}", response_model=ProductOut)
async def get_product(product_id: str, request: Request):
    doc = await _find_product_doc(product_id)
    if not doc:
        raise HTTPException(status_code=500, detail="Product not found")

    try:
        user: UserInDB = await get_current_user(request)
    except HTTPException:
        user = None

    if user:
        await actions_coll.insert_one(
            {
                "userId": user.id,
                "productId": str(doc["_id"]),
                "category": doc.get("category"),
                "action": ActionEnum.VIEW.value,
                "timestamp": datetime.utcnow(),
            }
        )

    return _product_out(doc)


@router.post("/{product_id}/like")
async def like_product(product_id: str, user: UserInDB = Depends(get_current_user)):
    doc = await _find_product_doc(product_id)
    if not doc:
        raise HTTPException(status_code=500, detail="Product not found")

    exists = await actions_coll.find_one(
        {"userId": user.id, "productId": str(doc["_id"]), "action": ActionEnum.LIKE.value}
    )
    if exists:
        raise HTTPException(status_code=400, detail="Like already exists")

    await actions_coll.insert_one(
        {
            "userId": user.id,
            "productId": str(doc["_id"]),
            "category": doc.get("category"),
            "action": ActionEnum.LIKE.value,
            "timestamp": datetime.utcnow(),
        }
    )
    return {"message": "liked"}


@router.delete("/{product_id}/like")
async def unlike_product(product_id: str, user: UserInDB = Depends(get_current_user)):
    doc = await _find_product_doc(product_id)
    if not doc:
        return {"status": 204}

    await actions_coll.delete_many(
        {
            "userId": user.id,
            "productId": str(doc["_id"]),
            "action": ActionEnum.LIKE.value,
        }
    )
    return {"status": 204}


@router.post("/{product_id}/buy")
async def buy_product(product_id: str, user: UserInDB = Depends(get_current_user)):
    doc = await _find_product_doc(product_id)
    if not doc:
        raise HTTPException(status_code=500, detail="Product not found")

    await actions_coll.insert_one(
        {
            "userId": user.id,
            "productId": str(doc["_id"]),
            "category": doc.get("category"),
            "action": ActionEnum.PURCHASE.value,
            "timestamp": datetime.utcnow(),
        }
    )
    return {"message": "purchased"}

--- app/routers/search.py ---
from typing import Optional, List

from fastapi import APIRouter, Query

from app.core.db import products_coll

router = APIRouter(prefix="/api/v1/search", tags=["search"])


def _match_tokens(s: str, tokens: List[str]) -> bool:
    s = (s or "").lower()
    return all(t in s for t in tokens)


@router.get("")
async def search(
    q: str = Query(""),
    category: Optional[str] = None,
    price_from: Optional[int] = None,
    price_to: Optional[int] = None,
    limit: int = Query(50, ge=1, le=200),
):
    docs = await products_coll.find({}).to_list(length=1000)
    tokens = [t.strip().lower() for t in q.split()] if q else []

    out = []
    for d in docs:
        if category and d.get("category") != category:
            continue
        price = d.get("price") or 0
        if price_from is not None and price < price_from:
            continue
        if price_to is not None and price > price_to:
            continue
        if tokens:
            hay = " ".join([str(d.get("brand") or ""), str(d.get("model") or "")])
            if not _match_tokens(hay, tokens):
                continue

        out.append(
            {
                "id": str(d["_id"]),
                "brand": d.get("brand"),
                "model": d.get("model"),
                "price": d.get("price"),
                "category": d.get("category"),
            }
        )
        if len(out) >= limit:
            break

    return {"count": len(out), "items": out}

--- app/core/db.py ---
from motor.motor_asyncio import AsyncIOMotorClient
from .config import settings

client = AsyncIOMotorClient(settings.mongo_uri)
db = client[settings.mongo_db]

users_coll = db["users"]
products_coll = db["products"]
actions_coll = db["user_actions"]

--- app/core/config.py ---
from pydantic import BaseModel
import os
from dotenv import load_dotenv

load_dotenv()


class Settings(BaseModel):
    port: int = int(os.getenv("PORT", "8080"))

    mongo_uri: str = os.getenv("MONGO_URI", "mongodb://localhost:27017")
    mongo_db: str = os.getenv("MONGO_DB", "daystore")

    svc_username: str = os.getenv("SVC_USERNAME", "service_bot")
    svc_password: str = os.getenv("SVC_PASSWORD", "service_bot_secret")


settings = Settings()

--- app/core/security.py ---
import base64
from typing import Optional

from fastapi import Depends, HTTPException, Request, status
from passlib.context import CryptContext
from bson import ObjectId

from .db import users_coll
from app.models import UserInDB
from .config import settings

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def hash_password(password: str) -> str:
    """Ğ¥ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ bcrypt"""
    return pwd_context.hash(password)


def verify_password(plain: str, hashed: str) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ"""
    if hashed.startswith("$2a$") or hashed.startswith("$2b$") or hashed.startswith("$2y$"):
        return pwd_context.verify(plain, hashed)
    return plain == hashed


async def _find_user_by_username(username: str) -> Optional[UserInDB]:
    """ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ username"""
    doc = await users_coll.find_one({"username": username})
    if not doc:
        return None
    return UserInDB(
        id=str(doc.get("_id")),
        username=doc["username"],
        password=doc["password"],
    )


async def get_current_user(request: Request) -> UserInDB:
    """
    ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· Basic Auth
    Ğ’ĞĞ–ĞĞ: ĞĞµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ WWW-Authenticate Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ²ÑĞ¿Ğ»Ñ‹Ğ²Ğ°ÑÑ‰ĞµĞ³Ğ¾ Ğ¾ĞºĞ½Ğ° Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°
    """
    auth = request.headers.get("Authorization")
    if not auth or not auth.startswith("Basic "):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Not authenticated"
        )

    try:
        decoded = base64.b64decode(auth.split(" ", 1)[1]).decode("utf-8")
        username, password = decoded.split(":", 1)
    except Exception:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid Authorization header"
        )

    user = await _find_user_by_username(username)
    if not user or not verify_password(password, user.password):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid username or password"
        )

    return user


async def ensure_service_user():
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ"""
    existing = await users_coll.find_one({"username": settings.svc_username})
    if existing:
        return

    doc = {
        "username": settings.svc_username,
        "password": hash_password(settings.svc_password),
    }
    await users_coll.insert_one(doc)
--- static/index.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore â€” ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container wide fade-in">

  <section class="hero">
    <div>
      <h1>Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ğ½Ğ°Ñˆ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½</h1>
      <p>Ğ˜Ğ½Ñ‚ĞµĞ»Ğ»ĞµĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ¸ Ñ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸</p>
      <div class="searchbar">
        <input id="searchInput" type="text" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ±Ñ€ĞµĞ½Ğ´ Ğ¸Ğ»Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒâ€¦" />
        <button id="btnSearch" class="btn">ĞŸĞ¾Ğ¸ÑĞº</button>
      </div>
    </div>
    <img src="https://cdn.jsdelivr.net/gh/encharm/Font-Awesome-SVG-PNG/white/png/256/laptop.png" alt="banner" style="justify-self:end;max-width:260px;">
  </section>

  <div class="layout" style="margin-top:32px;">
    <aside class="sidebar">
      <div class="section-title"><h3>ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸</h3></div>
      <div id="catFilters" class="chips">
        <label class="chip"><input type="checkbox" value="LAPTOP"> LAPTOP</label>
        <label class="chip"><input type="checkbox" value="PC"> PC</label>
        <label class="chip"><input type="checkbox" value="HEADPHONE"> HEADPHONE</label>
        <label class="chip"><input type="checkbox" value="SMART_WATCH"> SMART WATCH</label>
        <label class="chip"><input type="checkbox" value="CAMERA"> CAMERA</label>
        <label class="chip"><input type="checkbox" value="PHONE"> PHONE</label>
      </div>
      <div class="btn-row" style="margin-top:16px;">
        <button id="btnApplyCats" class="btn block outline">ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button>
        <button id="btnResetCats" class="btn block ghost">Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ</button>
      </div>
    </aside>

    <section class="panel">
      <div class="panel-title"><h2>ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³</h2></div>
      <div id="products" class="grid auto-fit"></div>
    </section>
  </div>

  <section id="recoSection" class="panel" style="margin-top:40px;display:none;">
    <div class="panel-title">
      <h2>Ğ’Ğ°ÑˆĞ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸</h2>
      <div id="recoHint" class="muted"></div>
    </div>
    <div id="recoList" class="grid auto-fit"></div>
  </section>

</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/catalog.js"></script>
</body>
</html>

--- static/product.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore â€” Product</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container narrow">
  <section id="productBox" class="panel"></section>
</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/product.js"></script>
</body>
</html>

--- static/cart.js ---
import { cartList, cartRemove, cartClear, reflectAuthStatus, fetchJSON, getAuthToken, out } from "./common.js";

function render(){
  reflectAuthStatus();
  const items = cartList();
  const wrap = document.getElementById("cartList");
  if(!wrap) return;
  if(!items.length){ wrap.innerHTML = `<div class="muted">Your cart is empty</div>`; return; }
  wrap.innerHTML = `
    <table class="table">
      <thead><tr><th>Item</th><th>Price</th><th></th></tr></thead>
      <tbody>
        ${items.map(it=>`
          <tr>
            <td>${it.brand||"?"} â€” ${it.model||"?"}<div class="mono">id: ${it.id}</div></td>
            <td>${it.price ?? "-"}</td>
            <td><button class="btn ghost rm" data-id="${it.id}">Remove</button></td>
          </tr>`).join("")}
      </tbody>
    </table>
  `;
}

async function checkout(){
  const items = cartList(); if(!items.length) return out("Cart is empty");
  if(!getAuthToken()) return out("Login required (Account page)");
  let ok=0, fail=0;
  for(const it of items){
    try{ await fetchJSON(`/api/v1/products/${it.id}/buy`, {method:"POST"}); ok++; }
    catch(e){ fail++; out(`Error ${it.id}: ${e.message}`); }
  }
  out(`Purchased: ${ok}, errors: ${fail}`);
  render();
}

document.addEventListener("click", e=>{
  const rm = e.target.closest("button.rm"); if(rm){ cartRemove(rm.dataset.id); render(); }
});
document.addEventListener("DOMContentLoaded", ()=>{
  render();
  document.getElementById("btnCheckout").addEventListener("click", checkout);
  document.getElementById("btnClear").addEventListener("click", ()=>{ cartClear(); render(); });
});

--- static/user.js ---
import { fetchJSON, makeBasic, setAuthToken, getAuthToken } from "./common.js";

function showHTML(html) {
  const box = document.getElementById("pretty");
  if (box) box.innerHTML = html;
}

async function onRegister() {
  const username = document.getElementById("regUser").value.trim();
  const password = document.getElementById("regPass").value;
  const confirm = document.getElementById("regPass2")?.value ?? password;

  // Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğµ
  if (!username || !password) {
    showHTML(`<div class="warn">âš ï¸ Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ</div>`);
    return;
  }

  if (username.length < 3) {
    showHTML(`<div class="warn">âš ï¸ Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğµ Ğ¼ĞµĞ½ĞµĞµ 3 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²</div>`);
    return;
  }

  if (password.length < 6) {
    showHTML(`<div class="warn">âš ï¸ ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ½Ğµ Ğ¼ĞµĞ½ĞµĞµ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²</div>`);
    return;
  }

  if (password !== confirm) {
    showHTML(`<div class="error">âŒ ĞŸĞ°Ñ€Ğ¾Ğ»Ğ¸ Ğ½Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚</div>`);
    return;
  }

  try {
    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ½Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
    const response = await fetch(`/api/v1/users/registration`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        username: username,
        password: password,
        passwordConfirmation: confirm
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      let errorMsg = errorText;
      try {
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.detail || errorText;
      } catch (e) {
        // Ğ•ÑĞ»Ğ¸ Ğ½Ğµ JSON, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ
      }
      throw new Error(errorMsg);
    }

    const data = await response.json();

    showHTML(`
      <div class="card success fade-in">
        <h3>âœ… Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾</h3>
        <p>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ '<b>${data.username}</b>' ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½</p>
        <p class="muted">Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ</p>
      </div>
    `);

    // ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿Ğ¾Ğ»ĞµĞ¹
    document.getElementById("regUser").value = "";
    document.getElementById("regPass").value = "";
    document.getElementById("regPass2").value = "";

  } catch (err) {
    showHTML(`<div class="error">âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸: ${err.message}</div>`);
    console.error("Registration error:", err);
  }
}

async function onLogin() {
  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPass").value;

  if (!username || !password) {
    showHTML(`<div class="warn">âš ï¸ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ</div>`);
    return;
  }

  const token = makeBasic(username, password);

  try {
    const response = await fetch(`/api/v1/users/me/username`, {
      headers: {
        "Authorization": token
      }
    });

    if (!response.ok) {
      let errorMsg = "ĞĞµĞ²ĞµÑ€Ğ½Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ";
      try {
        const errorText = await response.text();
        const errorJson = JSON.parse(errorText);
        errorMsg = errorJson.detail || errorMsg;
      } catch (e) {
        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
      }
      throw new Error(errorMsg);
    }

    const usernameFromServer = await response.text();
    const cleanName = usernameFromServer.trim();

    setAuthToken(token);

    showHTML(`
      <div class="card success fade-in">
        <h3>ğŸ‰ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ!</h3>
        <p>âœ… Ğ’Ñ…Ğ¾Ğ´ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½ ĞºĞ°Ğº <b>${cleanName}</b></p>
        <p class="muted">Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ°Ğ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸</p>
      </div>
    `);

    document.getElementById("loginPass").value = "";

    if (window.reflectAuthStatus) {
      window.reflectAuthStatus();
    }

    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ Ğ¸ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ°
    await onWhoAmI();
    await onHistory();

  } catch (err) {
    setAuthToken("");
    showHTML(`<div class="error">âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°: ${err.message}</div>`);
    console.error("Login error:", err);
  }
}

function onLogout() {
  setAuthToken("");
  showHTML(`
    <div class="info fade-in">
      <h3>ğŸ‘‹ Ğ”Ğ¾ ÑĞ²Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ!</h3>
      <p>ğŸšª Ğ’Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ²Ñ‹ÑˆĞ»Ğ¸ Ğ¸Ğ· ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹</p>
    </div>
  `);

  document.getElementById("loginUser").value = "";
  document.getElementById("loginPass").value = "";

  // ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ±Ğ»Ğ¾ĞºĞ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸
  document.getElementById("userInfo").innerHTML = `<div class="muted">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ</div>`;
  document.getElementById("historyContent").innerHTML = `<div class="muted">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</div>`;

  if (window.reflectAuthStatus) {
    window.reflectAuthStatus();
  }
}

async function onWhoAmI() {
  const userInfoDiv = document.getElementById("userInfo");

  if (!getAuthToken()) {
    userInfoDiv.innerHTML = `<div class="muted">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ</div>`;
    return;
  }

  try {
    const response = await fetch(`/api/v1/users/me`, {
      headers: {
        "Authorization": getAuthToken()
      }
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();

    userInfoDiv.innerHTML = `
      <div class="kv">
        <div><span>ID</span><b class="mono">${data.id}</b></div>
        <div><span>Username</span><b>${data.username}</b></div>
      </div>
    `;
  } catch (e) {
    userInfoDiv.innerHTML = `<div class="error">âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ${e.message}</div>`;
    console.error("WhoAmI error:", e);
  }
}

async function onHistory() {
  const historyDiv = document.getElementById("historyContent");

  if (!getAuthToken()) {
    historyDiv.innerHTML = `<div class="muted">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</div>`;
    return;
  }

  try {
    const data = await fetchJSON(`/api/v1/users/me/history?all=true`);

    if (!Array.isArray(data) || !data.length) {
      historyDiv.innerHTML = `<div class="muted">ğŸ“­ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¿ÑƒÑÑ‚Ğ°</div>`;
      return;
    }

    const rows = data.map(a => {
      const date = new Date(a.timestamp);
      const formattedDate = date.toLocaleString('ru-RU');

      return `
      <tr>
        <td>${formattedDate}</td>
        <td><span class="badge">${a.action}</span></td>
        <td class="mono">${a.productId ? a.productId.substring(0, 8) + '...' : '-'}</td>
        <td>${a.category ?? "-"}</td>
      </tr>
    `}).join("");

    historyDiv.innerHTML = `
      <p class="muted" style="margin-bottom:12px;">Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹: ${data.length}</p>
      <table class="table compact">
        <thead>
          <tr>
            <th>Ğ’Ñ€ĞµĞ¼Ñ</th>
            <th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ</th>
            <th>ID Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°</th>
            <th>ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  } catch (e) {
    historyDiv.innerHTML = `<div class="error">âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸: ${e.message}</div>`;
    console.error("History error:", e);
  }
}

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ² ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btnRegister").addEventListener("click", onRegister);
  document.getElementById("btnLogin").addEventListener("click", onLogin);
  document.getElementById("btnLogout").addEventListener("click", onLogout);
  document.getElementById("btnHistory").addEventListener("click", onHistory);

  // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Enter Ğ² Ğ¿Ğ¾Ğ»ÑÑ… Ğ²Ğ²Ğ¾Ğ´Ğ°
  document.getElementById("regPass2")?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") onRegister();
  });

  document.getElementById("loginPass")?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") onLogin();
  });

  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
  if (getAuthToken()) {
    onWhoAmI();
    onHistory();
  }
});
--- static/catalog.js ---
import { fetchJSON, out, reflectAuthStatus, getAuthToken } from "./common.js";

function escapeHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

function cardHtml(p) {
  return `
    <div class="card hover-raise">
      <div class="card-head">
        <h3 style="margin:0;font-size:18px">${escapeHtml(p.brand || "?")} â€” ${escapeHtml(p.model || "?")}</h3>
        <a class="btn ghost" href="/product.html?id=${encodeURIComponent(p.id)}">Open</a>
      </div>
      <div class="mono">id: ${escapeHtml(p.id || "")}</div>
      <div>Category: <b>${escapeHtml(p.category || "-")}</b></div>
      <div>Price: <b class="price">${p.price ?? "-"}</b></div>
      <div class="actions">
        <button class="btn outline action" data-act="view" data-id="${p.id}">View</button>
        <button class="btn action" data-act="like" data-id="${p.id}">Like</button>
        <button class="btn ghost action" data-act="unlike" data-id="${p.id}">Unlike</button>
        <button class="btn success action" data-act="buy" data-id="${p.id}">Buy</button>
      </div>
    </div>
  `;
}

function renderProducts(items) {
  const wrap = document.getElementById("products");
  if (!wrap) return;
  wrap.innerHTML = items.map(cardHtml).join("");
}

async function loadProducts({ useCache = false } = {}) {
  try {
    const data = await fetchJSON(`/api/v1/products?use_cache=${useCache ? "true" : "false"}`);
    renderProducts(data.items || []);
    await maybeLoadRecommendations();
  } catch (e) {
    out(e.message);
  }
}

document.addEventListener("click", async (e) => {
  const btn = e.target.closest("button.action");
  if (!btn) return;
  const act = btn.dataset.act;
  const pid = btn.dataset.id;
  try {
    if (act === "view") {
      const data = await fetchJSON(`/api/v1/products/${pid}`);
      out(data);
    } else if (act === "like") {
      const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "POST" });
      out(data);
    } else if (act === "unlike") {
      const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "DELETE" });
      out(data);
    } else if (act === "buy") {
      const data = await fetchJSON(`/api/v1/products/${pid}/buy`, { method: "POST" });
      out(data);
    }
  } catch (err) {
    out(err.message);
  }
});

async function onSearch() {
  const q = document.getElementById("searchInput")?.value.trim() || "";
  try {
    const data = await fetchJSON(`/api/v1/search?q=${encodeURIComponent(q)}`);
    renderProducts(data.items || []);
    out({ search: q, count: data.count });
  } catch (e) {
    out(e.message);
  }
}

async function maybeLoadRecommendations() {
  const list = document.getElementById("recoList");
  const hint = document.getElementById("recoHint");
  const section = document.getElementById("recoSection");
  if (!list || !hint || !section) return;

  section.style.display = "";
  hint.textContent = "ğŸ”„ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸...";
  list.innerHTML = `<div class="muted mono">Loading...</div>`;

  if (!getAuthToken()) {
    hint.textContent = "ğŸ”’ Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸";
    list.innerHTML = `<div class="muted mono">ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</div>`;
    return;
  }

  try {
    const data = await fetchJSON(`/api/v1/users/me/recommendation`);

    let items = [];
    if (Array.isArray(data)) items = data;
    else if (Array.isArray(data.items)) items = data.items;
    else if (Array.isArray(data.data)) items = data.data;
    else if (Array.isArray(data.recommendations)) items = data.recommendations;

    if (!items.length) {
      list.innerHTML = `<div class="muted">ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¹</div>`;
      hint.textContent = "ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…";
      section.style.display = "";
      return;
    }

    list.innerHTML = items
      .map(
        (p) => `
        <div class="card fade-in">
          <div class="card-head">
            <h4 style="margin:0">${escapeHtml(p.brand || "?")} â€” ${escapeHtml(p.model || "?")}</h4>
            <a class="btn ghost" href="/product.html?id=${encodeURIComponent(p.id)}">Open</a>
          </div>
          <div class="mono">id: ${escapeHtml(p.id || "")}</div>
          <div>Category: <b>${escapeHtml(p.category || "-")}</b></div>
          <div>Price: <b>${p.price ?? "-"}</b></div>
        </div>`
      )
      .join("");

    hint.textContent = "ğŸ¯ ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸";
    section.style.display = "";
  } catch (e) {
    console.error("RECO ERROR:", e);
    hint.textContent = "âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¹";
    list.innerHTML = `<div class="muted">ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ</div>`;
    section.style.display = "";
  }
}

function selectedCategories() {
  const w = document.getElementById("catFilters");
  if (!w) return [];
  return [...w.querySelectorAll('input[type="checkbox"]')]
    .filter((i) => i.checked)
    .map((i) => i.value.trim().toUpperCase());
}

async function applyCategoryFilter() {
  const cats = selectedCategories();
  if (!cats.length) {
    await loadProducts({ useCache: false });
    return;
  }
  const csv = cats.join(",");
  try {
    const data = await fetchJSON(`/api/v1/products/by-category?category=${encodeURIComponent(csv)}`);
    renderProducts(data.items || []);
    out({ filter: cats, count: data.count });
  } catch (e) {
    out(e.message);
  }
}

function resetCategoryFilter() {
  const w = document.getElementById("catFilters");
  if (w) w.querySelectorAll('input[type="checkbox"]').forEach((i) => (i.checked = false));
  loadProducts({ useCache: false }).catch(console.error);
}

document.getElementById("btnSearch")?.addEventListener("click", onSearch);
document.getElementById("btnApplyCats")?.addEventListener("click", applyCategoryFilter);
document.getElementById("btnResetCats")?.addEventListener("click", resetCategoryFilter);

reflectAuthStatus();
loadProducts({ useCache: false }).catch(console.error);


--- static/user.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore â€” ĞĞºĞºĞ°ÑƒĞ½Ñ‚</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>

<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container wide fade-in">
  <section class="panel" style="margin-top:30px;">
    <div class="panel-title">
      <h2>Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ¼</h2>
      <div class="muted">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¹</div>
    </div>

    <div class="grid cols-2" style="gap:24px;">
      <!-- Ğ›Ğ•Ğ’ĞĞ¯ Ğ§ĞĞ¡Ğ¢Ğ¬: Ğ’Ñ…Ğ¾Ğ´ Ğ¸ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ -->
      <div class="u-col" style="gap:24px;">
        <div class="card big fade-in">
          <h3 style="margin:0 0 12px">ğŸ” Ğ’Ñ…Ğ¾Ğ´</h3>
          <div class="u-col">
            <input id="loginUser" class="input" placeholder="Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ" />
            <input id="loginPass" class="input" type="password" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ" />
          </div>
          <div class="btn-row" style="margin-top:10px;">
            <button id="btnLogin" class="btn">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
            <button id="btnLogout" class="btn ghost">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
          </div>
        </div>

        <div class="card big fade-in">
          <h3 style="margin:0 0 12px">âœ¨ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</h3>
          <div class="u-col">
            <input id="regUser" class="input" placeholder="Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ" />
            <input id="regPass" class="input" type="password" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ" />
            <input id="regPass2" class="input" type="password" placeholder="ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ" />
            <button id="btnRegister" class="btn block">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</button>
          </div>
        </div>
      </div>

      <!-- ĞŸĞ ĞĞ’ĞĞ¯ Ğ§ĞĞ¡Ğ¢Ğ¬: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ + Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ -->
      <div class="u-col" style="gap:24px;">
        <div class="card big fade-in">
          <h3 style="margin:0 0 12px">ğŸ‘¤ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ</h3>
          <div id="userInfo" class="u-col">
            <div class="muted">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ</div>
          </div>
        </div>

        <div class="card big fade-in">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h3 style="margin:0">ğŸ“œ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹</h3>
            <button id="btnHistory" class="btn outline small">ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
          </div>
          <div id="historyContent" style="max-height:400px;overflow-y:auto;">
            <div class="muted">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ĞĞ˜Ğ–ĞĞ¯Ğ¯ Ğ§ĞĞ¡Ğ¢Ğ¬: Ğ’Ñ‹Ğ²Ğ¾Ğ´ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ -->
  <section class="panel fade-in">
    <div class="panel-title"><h3>ğŸ’¬ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ</h3></div>
    <div id="pretty" class="pretty"></div>
  </section>
</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/user.js"></script>
</body>
</html>
--- static/header.js ---
function renderHeader() {
  const host = document.getElementById("site-header");
  if (!host) return;

  host.innerHTML = `
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand"><span class="logo"></span><a href="/" class="brand-link">DayStore</a></div>

        <nav class="topnav">
          <a href="/" data-nav="catalog">Browse</a>
          <a href="/user.html" data-nav="user">Account</a>
          <a href="/cart.html" data-nav="cart">Cart <span data-cart-count class="mono" style="margin-left:6px;background:rgba(255,255,255,.06);padding:2px 8px;border-radius:999px">0</span></a>
        </nav>
        <div class="status"><span class="dot"></span><span data-auth-status>anonymous</span></div>
      </div>
    </div>
  `;

  const map = {
    "/": "catalog",
    "/index.html": "catalog",
    "/product.html": "catalog",
    "/user.html": "user",
    "/cart.html": "cart",
  };
  const active = map[(location.pathname||"/").toLowerCase()] || "catalog";
  host.querySelectorAll(".topnav a").forEach(a=>{
    a.classList.toggle("active", a.dataset.nav===active);
  });
}
document.addEventListener("DOMContentLoaded", renderHeader);

--- static/common.js ---
const LS_AUTH = "AUTH";
const LS_AUTH_TS = "AUTH_TS";
const SESSION_TTL_MS = 10 * 60 * 1000;

function nowMs(){ return Date.now(); }
function isExpired(ts){ return !ts || (nowMs()-ts)>SESSION_TTL_MS; }

export function getAuthToken(){
  const token = localStorage.getItem(LS_AUTH) || "";
  const ts = parseInt(localStorage.getItem(LS_AUTH_TS) || "0",10);
  if(!token) return "";
  if(isExpired(ts)){
    localStorage.removeItem(LS_AUTH); localStorage.removeItem(LS_AUTH_TS);
    reflectAuthStatus(); return "";
  }
  return token;
}
function touch(){ localStorage.setItem(LS_AUTH_TS, String(nowMs())); }

export function setAuthToken(token){
  if(token){ localStorage.setItem(LS_AUTH, token); touch(); }
  else { localStorage.removeItem(LS_AUTH); localStorage.removeItem(LS_AUTH_TS); }
  reflectAuthStatus();
}
export function makeBasic(u,p){ return "Basic " + btoa(`${u}:${p}`); }

export function reflectAuthStatus(){
  const s = document.querySelector("[data-auth-status]");
  if(s){
    const tok = getAuthToken();
    s.textContent = tok ? "authorized" : "anonymous";
    const dot = document.querySelector(".status .dot");
    if(dot) dot.style.background = tok ? "var(--success)" : "#ffd166";
  }
  document.querySelectorAll("[data-cart-count]").forEach(e=>e.textContent=String(cartCount()));
}

function attachAuth(opts={}){
  const headers = opts.headers || {};
  const tok = getAuthToken();
  if(tok && !headers["Authorization"]){ headers["Authorization"]=tok; touch(); }
  return {...opts, headers};
}

export async function fetchJSON(url, opts={}){
  const r = await fetch(url, attachAuth(opts));
  if(!r.ok){
    const txt = await r.text();
    if(r.status===401 || r.status===403){ setAuthToken(""); throw new Error("Unauthorized: go to Account and log in."); }
    throw new Error(`HTTP ${r.status}: ${txt}`);
  }
  const ct = r.headers.get("content-type")||"";
  return ct.includes("application/json") ? r.json() : r.text();
}

export function out(msg, id="output"){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = (typeof msg==="string") ? msg : JSON.stringify(msg,null,2);
}

/* --- Cart --- */
const LS_CART = "CART_V1";
function readCart(){ try{ return JSON.parse(localStorage.getItem(LS_CART)||"[]"); }catch{return []} }
function writeCart(items){ localStorage.setItem(LS_CART, JSON.stringify(items)); reflectAuthStatus(); }
export function cartList(){ return readCart(); }
export function cartCount(){ return readCart().length; }
export function cartAdd(item){ const xs = readCart(); if(!xs.find(x=>x.id===item.id)){ xs.push(item); writeCart(xs); } }
export function cartRemove(id){ writeCart(readCart().filter(x=>x.id!==id)); }
export function cartClear(){ writeCart([]); }

document.addEventListener("DOMContentLoaded", reflectAuthStatus);

--- static/cart.html ---
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DayStore â€” Cart</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div id="site-header"></div>
<script type="module" src="/header.js"></script>

<main class="container narrow">
  <section class="panel">
    <h2 style="margin:0 0 12px">Your Cart</h2>
    <div id="cartList"></div>
    <div class="actions" style="margin-top:12px">
      <button id="btnCheckout" class="btn success">Checkout</button>
      <button id="btnClear" class="btn ghost">Clear</button>
    </div>
  </section>
  <section>
    <h3>Console</h3>
    <pre id="output" class="log"></pre>
  </section>
</main>

<script type="module" src="/common.js"></script>
<script type="module" src="/cart.js"></script>
</body>
</html>

--- static/product.js ---
import { fetchJSON, out, getAuthToken, cartAdd } from "./common.js";

function isLoggedIn(){ return !!getAuthToken(); }
function getId(){ return new URL(location.href).searchParams.get("id") || ""; }

function skeleton(id){
  const box = document.getElementById("productBox");
  box.innerHTML = `
    <div class="big card">
      <div class="card-head">
        <h2 id="pTitle" style="margin:0">Loadingâ€¦</h2>
        <div class="mono">id: ${id}</div>
      </div>
      <div id="pInfo" class="kv" style="margin-top:10px">
        <div><span>Category</span><b>â€”</b></div>
        <div><span>Price</span><b>â€”</b></div>
        <div><span>Status</span><b id="pStatus" class="muted">Waiting serverâ€¦</b></div>
      </div>
      <div class="actions" style="margin-top:14px">
        <button class="btn" data-act="view">View</button>
        <button class="btn ${isLoggedIn()?"":"ghost"} need-auth" data-act="like">Like</button>
        <button class="btn ghost need-auth" data-act="unlike">Unlike</button>
        <button class="btn outline" data-act="cart" data-brand="" data-model="" data-price="">Add to Cart</button>
        <button class="btn success need-auth" data-act="buy">Buy</button>
      </div>
    </div>
  `;
  reflectAuth();
}
function reflectAuth(){
  document.querySelectorAll(".need-auth").forEach(b=>{
    if(isLoggedIn()){ b.removeAttribute("disabled"); b.classList.remove("ghost"); }
    else { b.setAttribute("disabled","disabled"); b.classList.add("ghost"); }
  });
}

function hydrate(p){
  document.getElementById("pTitle").textContent = `${p.brand||"?"} â€” ${p.model||"?"}`;
  document.getElementById("pInfo").innerHTML = `
    <div><span>Category</span><b>${p.category || "-"}</b></div>
    <div><span>Price</span><b>${p.price ?? "-"}</b></div>
    <div><span>Status</span><b class="muted">Ready</b></div>
  `;
  const btnCart = document.querySelector('button[data-act="cart"]');
  if(btnCart){ btnCart.dataset.brand = p.brand||""; btnCart.dataset.model = p.model||""; btnCart.dataset.price = p.price ?? ""; }
}
function notFound(){
  document.getElementById("pTitle").textContent = "Product not found";
  const s = document.getElementById("pStatus"); if(s) s.textContent="Check product id";
}

async function load(){
  const id = getId(); if(!id){ out("No product id specified"); return; }
  skeleton(id);
  try{ const data = await fetchJSON(`/api/v1/products/${encodeURIComponent(id)}`); hydrate(data); }
  catch(e){ notFound(); out(e.message); }
}

document.addEventListener("click", async (e)=>{
  const btn = e.target.closest("button.btn"); if(!btn) return;
  const act = btn.dataset.act; const id = getId();
  try{
    if(act==="view"){
      const data = await fetchJSON(`/api/v1/products/${id}`); out(data);
    }else if(act==="like"){
      if(!isLoggedIn()) return out("Login required");
      const data = await fetchJSON(`/api/v1/products/${id}/like`, {method:"POST"}); out(data);
    }else if(act==="unlike"){
      if(!isLoggedIn()) return out("Login required");
      const res = await fetchJSON(`/api/v1/products/${id}/like`, {method:"DELETE"});
      out(typeof res==="string"?res:"unliked (204)");
    }else if(act==="cart"){
      cartAdd({id, brand:btn.dataset.brand||"", model:btn.dataset.model||"", price: btn.dataset.price?Number(btn.dataset.price):null});
      out("Added to cart");
    }else if(act==="buy"){
      if(!isLoggedIn()) return out("Login required");
      const data = await fetchJSON(`/api/v1/products/${id}/buy`, {method:"POST"}); out(data);
    }
  }catch(err){ out(err.message); }
});

window.addEventListener("storage", ev=>{ if(ev.key==="AUTH"){ reflectAuth(); } });

document.addEventListener("DOMContentLoaded", load);

--- static/app.js ---
(function () {

  const out = (msg) => {
    const el = document.getElementById("output");
    el.textContent = (typeof msg === "string") ? msg : JSON.stringify(msg, null, 2);
  };


  function getAuthToken() { return localStorage.getItem("AUTH") || ""; }
  function setAuthToken(token) {
    if (token) localStorage.setItem("AUTH", token);
    else localStorage.removeItem("AUTH");
    reflectAuthStatus();
    updateControlsState();
  }
  function makeBasic(u, p) { return "Basic " + btoa(`${u}:${p}`); }

  function reflectAuthStatus() {
    const span = document.getElementById("authStatus");
    const tok = getAuthToken();
    if (!span) return;
    if (!tok) { span.textContent = "anonymous"; span.style.color = "#ffd166"; }
    else { span.textContent = "authorized"; span.style.color = "#06d6a0"; }
  }

  function updateControlsState() {
    const authed = !!getAuthToken();
    const btnWho = document.getElementById("btnWhoAmI");
    const btnHist = document.getElementById("btnHistory");
    const actions = document.querySelectorAll("button.action");

    if (btnWho) btnWho.disabled = !authed;
    if (btnHist) btnHist.disabled = !authed;

    actions.forEach(b => {
      const act = b.dataset.act;
      b.disabled = (act !== "view" && !authed);
    });
  }


  async function fetchJSON(url, opts = {}) {
    opts.headers = opts.headers || {};
    const auth = getAuthToken();
    if (auth && !opts.headers["Authorization"]) {
      opts.headers["Authorization"] = auth;
    }
    const r = await fetch(url, opts);
    if (!r.ok) {
      const txt = await r.text();
      if (r.status === 401 || r.status === 403) {
        throw new Error("Unauthorized: Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸Ğ½ Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ (Basic)");
      }
      throw new Error(`HTTP ${r.status}: ${txt}`);
    }
    const ct = r.headers.get("content-type") || "";
    return ct.includes("application/json") ? r.json() : r.text();
  }

  async function loadProducts() {
    try {
      const useCache = getAuthToken() ? "false" : "true";
      const data = await fetchJSON(`/api/v1/products?use_cache=${useCache}`);
      renderProducts(data.items || []);
      updateControlsState();
    } catch (e) {
      out(e.message);
    }
  }

  function renderProducts(items) {
    const wrap = document.getElementById("products");
    if (!wrap) return;
    wrap.innerHTML = "";
    items.forEach(p => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3>${p.brand || "?"} â€” ${p.model || "?"}</h3>
        <div class="mono">id: ${p.id}</div>
        <div>ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ: <b>${p.category || "-"}</b></div>
        <div>Ğ¦ĞµĞ½Ğ°: <b>${p.price ?? "-"}</b></div>
        <div class="actions">
          <button class="action" data-act="view" data-id="${p.id}">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
          <button class="action" data-act="like" data-id="${p.id}">Like</button>
          <button class="action" data-act="unlike" data-id="${p.id}">Unlike</button>
          <button class="action" data-act="buy" data-id="${p.id}">Buy</button>
        </div>
      `;
      wrap.appendChild(card);
    });
  }

  async function onAction(e) {
    const btn = e.target.closest("button.action");
    if (!btn) return;
    const act = btn.dataset.act;
    const pid = btn.dataset.id;

    if ((act === "like" || act === "unlike" || act === "buy") && !getAuthToken()) {
      out("Unauthorized: ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ (Basic)");
      return;
    }

    try {
      if (act === "view") {
        const data = await fetchJSON(`/api/v1/products/${pid}`);
        out(data);
      } else if (act === "like") {
        const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "POST" });
        out(data);
      } else if (act === "unlike") {
        const data = await fetchJSON(`/api/v1/products/${pid}/like`, { method: "DELETE" });
        out(data);
      } else if (act === "buy") {
        const data = await fetchJSON(`/api/v1/products/${pid}/buy`, { method: "POST" });
        out(data);
      }
    } catch (err) {
      out(err.message);
    }
  }

  async function onSearch() {
    const inp = document.getElementById("searchInput");
    const q = inp ? inp.value.trim() : "";
    try {
      const data = await fetchJSON(`/api/v1/search?q=${encodeURIComponent(q)}`);
      renderProducts(data.items || []);
      out({ search: q, count: data.count });
      updateControlsState();
    } catch (e) {
      out(e.message);
    }
  }


  async function onRegister() {
    const u = document.getElementById("authUser")?.value.trim();
    const p = document.getElementById("authPass")?.value;
    if (!u || !p) return out("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ username Ğ¸ password Ğ´Ğ»Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸");
    try {
      const res = await fetchJSON(`/api/v1/users/registration`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: u, password: p, passwordConfirmation: p })
      });
      out(res);
    } catch (e) {
      out(e.message);
    }
  }

  async function onLogin() {
    const u = document.getElementById("authUser")?.value.trim();
    const p = document.getElementById("authPass")?.value;
    if (!u || !p) return out("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ username Ğ¸ password Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ°");
    const token = makeBasic(u, p);
    try {
      const r = await fetch(`/api/v1/users/me/username`, { headers: { "Authorization": token } });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`Login failed: HTTP ${r.status}: ${txt}`);
      }
      const txt = await r.text();
      setAuthToken(token);
      out({ login: "ok", whoami: txt.trim() });
      await loadProducts();
    } catch (e) {
      setAuthToken("");
      out(e.message);
    }
  }

  function onLogout() {
    setAuthToken("");
    out("logged out");
    updateControlsState();
  }

  async function whoAmI() {
    if (!getAuthToken()) { out("Unauthorized: Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ (Basic)"); return; }
    try {
      const data = await fetchJSON(`/api/v1/users/me/username`);
      out(data);
    } catch (e) {
      out(e.message);
    }
  }

  async function myHistory() {
    if (!getAuthToken()) { out("Unauthorized: Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ (Basic)"); return; }
    try {
      const data = await fetchJSON(`/api/v1/users/me/history?all=true`);
      out(data);
    } catch (e) {
      out(e.message);
    }
  }


  document.addEventListener("DOMContentLoaded", () => {

    document.addEventListener("click", onAction);

    document.getElementById("btnSearch")?.addEventListener("click", onSearch);
    document.getElementById("btnRegister")?.addEventListener("click", onRegister);
    document.getElementById("btnLogin")?.addEventListener("click", onLogin);
    document.getElementById("btnLogout")?.addEventListener("click", onLogout);
    document.getElementById("btnWhoAmI")?.addEventListener("click", whoAmI);
    document.getElementById("btnHistory")?.addEventListener("click", myHistory);

    reflectAuthStatus();
    loadProducts().finally(updateControlsState);
  });

})();
